name: Benchmarks

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  schedule:
    # Run full benchmarks every night at 3 AM UTC
    - cron: '0 3 * * *'
  workflow_dispatch:
    inputs:
      full_benchmark:
        description: 'Run full benchmarks (including 100K records)'
        required: false
        default: 'false'
        type: boolean

jobs:
  micro-benchmarks:
    name: Vitest Micro-Benchmarks
    runs-on: ubuntu-latest
    timeout-minutes: 10
    # Skip full benchmarks on push/PR, run quick version
    if: github.event_name != 'schedule' && (github.event_name != 'workflow_dispatch' || github.event.inputs.full_benchmark != 'true')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm via corepack
        run: |
          corepack enable
          corepack prepare pnpm@10 --activate

      - run: pnpm install
      - run: pnpm build

      - name: Run quick micro-benchmarks (up to 10K records)
        run: pnpm bench
        working-directory: packages/core
        env:
          BENCH_QUICK: 'true'

  full-benchmarks:
    name: Full Micro-Benchmarks (100K records)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Run full benchmarks on schedule or manual trigger with full_benchmark=true
    if: github.event_name == 'schedule' || (github.event_name == 'workflow_dispatch' && github.event.inputs.full_benchmark == 'true')
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Setup pnpm via corepack
        run: |
          corepack enable
          corepack prepare pnpm@10 --activate

      - run: pnpm install
      - run: pnpm build

      - name: Run full micro-benchmarks
        run: pnpm bench
        working-directory: packages/core

  # NOTE: k6 tests are disabled in CI because they require a custom k6 build
  # with xk6-msgpack extension for MessagePack support.
  #
  # To run k6 tests locally:
  #   1. Build custom k6: pnpm test:k6:build
  #   2. Start server: pnpm start:server
  #   3. Run tests: pnpm test:k6:smoke (or other k6 test scripts)
  #
  # k6-smoke-test:
  #   name: k6 Smoke Test
  #   runs-on: ubuntu-latest
  #   ...
  #
  # k6-throughput-benchmark:
  #   name: k6 Throughput Benchmark
  #   runs-on: ubuntu-latest
  #   ...
