# Plan: 01-02 â€” JWT Secret Production Validation

## Frontmatter

| Field | Value |
|-------|-------|
| Plan ID | 01-02 |
| Phase | 1 |
| Wave | 1 |
| Depends on | none |
| Autonomous | true |
| Files modified | `packages/server/src/utils/validateConfig.ts`, `packages/server/src/utils/__tests__/validateConfig.test.ts`, `packages/server/src/ServerCoordinator.ts`, `packages/server/src/bootstrap/BootstrapController.ts`, `packages/server/src/settings/SettingsController.ts` |

## Objective

Create a JWT secret validation utility that throws an error in production mode when JWT_SECRET is missing or uses the default value, then integrate it across all three JWT initialization points (SEC-01).

## must_haves

- [ ] validateJwtSecret function exists and throws Error in production mode if secret is missing
- [ ] validateJwtSecret throws Error in production mode if secret is the default 'topgun-secret-dev'
- [ ] validateJwtSecret returns the effective secret (with development fallback) in non-production mode
- [ ] ServerCoordinator uses validateJwtSecret in constructor
- [ ] BootstrapController uses validateJwtSecret in constructor
- [ ] SettingsController uses validateJwtSecret in constructor
- [ ] Error messages are actionable, explaining how to fix the issue
- [ ] Unit tests cover all validation scenarios

## Tasks

<task id="1">
**Create validateJwtSecret utility**

<files>packages/server/src/utils/validateConfig.ts</files>

<action>
Create a new file `validateConfig.ts` in the utils directory:

```typescript
/**
 * Validates JWT secret configuration for production safety.
 *
 * In production mode (NODE_ENV === 'production'):
 * - Throws if no secret is provided (neither config nor env var)
 * - Throws if the default development secret is used
 *
 * In development mode:
 * - Falls back to 'topgun-secret-dev' if no secret provided
 *
 * @param configSecret - Secret from config object
 * @param envSecret - Secret from environment variable
 * @returns The effective JWT secret to use
 * @throws Error if validation fails in production mode
 */
export function validateJwtSecret(
    configSecret: string | undefined,
    envSecret: string | undefined
): string {
    const isProduction = process.env.NODE_ENV === 'production';
    const effectiveSecret = configSecret || envSecret;
    const DEFAULT_SECRET = 'topgun-secret-dev';

    if (isProduction) {
        if (!effectiveSecret) {
            throw new Error(
                'SECURITY ERROR: JWT_SECRET is required in production mode.\n' +
                'Set the JWT_SECRET environment variable or pass jwtSecret in the config.\n' +
                'Example: JWT_SECRET=$(openssl rand -base64 32) node server.js'
            );
        }

        if (effectiveSecret === DEFAULT_SECRET) {
            throw new Error(
                'SECURITY ERROR: Default JWT_SECRET cannot be used in production mode.\n' +
                'The default secret "topgun-secret-dev" is publicly known and insecure.\n' +
                'Generate a secure secret: openssl rand -base64 32'
            );
        }
    }

    // Development fallback
    return effectiveSecret || DEFAULT_SECRET;
}
```

Export from the module.
</action>

<verify>
- File exists at `packages/server/src/utils/validateConfig.ts`
- TypeScript compiles: `cd packages/server && pnpm build`
</verify>

<done>validateJwtSecret function exists with production validation logic and actionable error messages</done>
</task>

<task id="2" depends_on="1">
**Add unit tests for validateJwtSecret**

<files>packages/server/src/utils/__tests__/validateConfig.test.ts</files>

<action>
Create test file with comprehensive coverage:

```typescript
import { validateJwtSecret } from '../validateConfig';

describe('validateJwtSecret', () => {
    const originalEnv = process.env.NODE_ENV;

    afterEach(() => {
        process.env.NODE_ENV = originalEnv;
    });

    describe('production mode', () => {
        beforeEach(() => {
            process.env.NODE_ENV = 'production';
        });

        test('should throw if no secret provided', () => {
            expect(() => validateJwtSecret(undefined, undefined))
                .toThrow('SECURITY ERROR: JWT_SECRET is required in production mode');
        });

        test('should throw if only default secret provided via config', () => {
            expect(() => validateJwtSecret('topgun-secret-dev', undefined))
                .toThrow('Default JWT_SECRET cannot be used in production mode');
        });

        test('should throw if only default secret provided via env', () => {
            expect(() => validateJwtSecret(undefined, 'topgun-secret-dev'))
                .toThrow('Default JWT_SECRET cannot be used in production mode');
        });

        test('should return config secret when valid', () => {
            const result = validateJwtSecret('my-secure-secret', undefined);
            expect(result).toBe('my-secure-secret');
        });

        test('should return env secret when valid and config not provided', () => {
            const result = validateJwtSecret(undefined, 'env-secure-secret');
            expect(result).toBe('env-secure-secret');
        });

        test('should prefer config secret over env secret', () => {
            const result = validateJwtSecret('config-secret', 'env-secret');
            expect(result).toBe('config-secret');
        });
    });

    describe('development mode', () => {
        beforeEach(() => {
            process.env.NODE_ENV = 'development';
        });

        test('should return default secret when none provided', () => {
            const result = validateJwtSecret(undefined, undefined);
            expect(result).toBe('topgun-secret-dev');
        });

        test('should allow default secret explicitly', () => {
            const result = validateJwtSecret('topgun-secret-dev', undefined);
            expect(result).toBe('topgun-secret-dev');
        });

        test('should return provided secret when available', () => {
            const result = validateJwtSecret('custom-secret', undefined);
            expect(result).toBe('custom-secret');
        });
    });

    describe('test mode (default)', () => {
        beforeEach(() => {
            process.env.NODE_ENV = 'test';
        });

        test('should return default secret when none provided', () => {
            const result = validateJwtSecret(undefined, undefined);
            expect(result).toBe('topgun-secret-dev');
        });
    });
});
```
</action>

<verify>
- Tests pass: `cd packages/server && pnpm test -- --testPathPattern="validateConfig"`
</verify>

<done>All test cases pass covering production validation, development fallback, and secret precedence</done>
</task>

<task id="3" depends_on="2">
**Integrate validateJwtSecret into ServerCoordinator, BootstrapController, and SettingsController**

<files>packages/server/src/ServerCoordinator.ts, packages/server/src/bootstrap/BootstrapController.ts, packages/server/src/settings/SettingsController.ts</files>

<action>
**ServerCoordinator.ts** (around line 301):

1. Add import near top:
   ```typescript
   import { validateJwtSecret } from './utils/validateConfig';
   ```

2. Replace line 301:
   ```typescript
   const rawSecret = config.jwtSecret || process.env.JWT_SECRET || 'topgun-secret-dev';
   ```
   With:
   ```typescript
   const rawSecret = validateJwtSecret(config.jwtSecret, process.env.JWT_SECRET);
   ```

**BootstrapController.ts** (around line 117):

1. Add import near top:
   ```typescript
   import { validateJwtSecret } from '../utils/validateConfig';
   ```

2. Replace line 117:
   ```typescript
   this.jwtSecret = config.jwtSecret || process.env.JWT_SECRET || 'topgun-secret-dev';
   ```
   With:
   ```typescript
   this.jwtSecret = validateJwtSecret(config.jwtSecret, process.env.JWT_SECRET);
   ```

**SettingsController.ts** (around line 138):

1. Add import near top:
   ```typescript
   import { validateJwtSecret } from '../utils/validateConfig';
   ```

2. Replace line 138:
   ```typescript
   this.jwtSecret = config.jwtSecret || process.env.JWT_SECRET || 'topgun-secret-dev';
   ```
   With:
   ```typescript
   this.jwtSecret = validateJwtSecret(config.jwtSecret, process.env.JWT_SECRET);
   ```
</action>

<verify>
- Build succeeds: `cd packages/server && pnpm build`
- Existing tests pass: `pnpm --filter @topgunbuild/server test`
- Verify NODE_ENV=test still allows default secret (tests should pass)
</verify>

<done>All three JWT initialization points use validateJwtSecret, build passes, existing tests pass (they run in test mode which allows default secret)</done>
</task>

## Verification

After all tasks complete:

1. Build passes: `pnpm --filter @topgunbuild/server build`
2. All server tests pass: `pnpm --filter @topgunbuild/server test`
3. Manual verification: `NODE_ENV=production node -e "require('./packages/server/dist/ServerCoordinator')"` should throw error about missing JWT_SECRET

## Success Criteria

- [x] Server refuses to start in production mode without explicit JWT_SECRET
- [x] Server refuses to start in production mode with default JWT_SECRET
- [x] Error messages provide actionable guidance (how to generate a secure secret)
- [x] Development and test modes continue to work with default secret
- [x] All three initialization points validated consistently
