# Plan: 01-03 â€” HLC Strict Mode for Clock Drift Rejection

## Frontmatter

| Field | Value |
|-------|-------|
| Plan ID | 01-03 |
| Phase | 1 |
| Wave | 2 |
| Depends on | 01-01, 01-02 |
| Autonomous | true |
| Files modified | `packages/core/src/HLC.ts`, `packages/core/src/__tests__/HLC.test.ts` |

## Objective

Add configurable strict mode to HLC that rejects timestamps beyond a configurable drift threshold, throwing an error instead of just warning (SEC-02).

## must_haves

- [ ] HLC constructor accepts optional `HLCOptions` object with `strictMode` and `maxDriftMs` settings
- [ ] Default behavior unchanged: `strictMode` defaults to false, `maxDriftMs` defaults to 60000
- [ ] When `strictMode: true`, `update()` throws Error if remote timestamp exceeds drift threshold
- [ ] When `strictMode: false`, `update()` logs warning but accepts timestamp (existing behavior)
- [ ] Error message includes actual drift value and configured threshold
- [ ] Unit tests cover strict mode rejection and backwards compatibility

## Tasks

<task id="1">
**Extend HLC constructor with options parameter**

<files>packages/core/src/HLC.ts</files>

<action>
Modify HLC.ts to add configurable strict mode:

1. Add new interface before the class (after Timestamp interface):
   ```typescript
   /**
    * Configuration options for HLC behavior.
    */
   export interface HLCOptions {
       /**
        * When true, update() throws an error if remote timestamp drift exceeds maxDriftMs.
        * When false (default), a warning is logged but the timestamp is accepted.
        */
       strictMode?: boolean;

       /**
        * Maximum allowable clock drift in milliseconds.
        * Remote timestamps beyond this threshold trigger strict mode rejection or warning.
        * Default: 60000 (1 minute)
        */
       maxDriftMs?: number;
   }
   ```

2. Add private instance variables to the class (after line 10):
   ```typescript
   private readonly strictMode: boolean;
   private readonly maxDriftMs: number;
   ```

3. Modify constructor to accept optional options (change line 15-19):
   ```typescript
   constructor(nodeId: string, options: HLCOptions = {}) {
       this.nodeId = nodeId;
       this.strictMode = options.strictMode ?? false;
       this.maxDriftMs = options.maxDriftMs ?? 60000;
       this.lastMillis = 0;
       this.lastCounter = 0;
   }
   ```

4. Remove the static MAX_DRIFT constant (line 12-13) since we now use instance maxDriftMs.

5. Modify the update() method drift check (lines 55-59):
   ```typescript
   // Validate drift
   const drift = remote.millis - systemTime;
   if (drift > this.maxDriftMs) {
       const message = `Clock drift detected: Remote time ${remote.millis} is ${drift}ms ahead of local ${systemTime} (threshold: ${this.maxDriftMs}ms)`;

       if (this.strictMode) {
           throw new Error(message);
       } else {
           console.warn(message);
           // In AP systems we accept and fast-forward
       }
   }
   ```

6. Add getter methods for configuration (optional, useful for debugging):
   ```typescript
   public get getStrictMode(): boolean {
       return this.strictMode;
   }

   public get getMaxDriftMs(): number {
       return this.maxDriftMs;
   }
   ```
</action>

<verify>
- TypeScript compiles: `cd packages/core && pnpm build`
- Existing tests pass: `cd packages/core && pnpm test -- --testPathPattern="HLC"`
</verify>

<done>HLC class accepts HLCOptions with strictMode and maxDriftMs, compiles successfully, existing tests pass (they don't use strict mode)</done>
</task>

<task id="2" depends_on="1">
**Add strict mode tests to HLC.test.ts**

<files>packages/core/src/__tests__/HLC.test.ts</files>

<action>
Add new test section in HLC.test.ts for strict mode. Add after the "Clock Drift Detection" describe block (around line 375):

```typescript
describe('Strict Mode', () => {
    test('should throw error in strict mode when drift exceeds threshold', () => {
        const strictHlc = new HLC('strict-node', { strictMode: true, maxDriftMs: 5000 });
        const currentTime = 1000000;
        jest.spyOn(Date, 'now').mockImplementation(() => currentTime);

        const remote: Timestamp = {
            millis: currentTime + 10000, // 10 seconds ahead, exceeds 5s threshold
            counter: 0,
            nodeId: 'remote-node'
        };

        expect(() => strictHlc.update(remote)).toThrow('Clock drift detected');
        expect(() => strictHlc.update(remote)).toThrow('10000ms ahead');
        expect(() => strictHlc.update(remote)).toThrow('threshold: 5000ms');
    });

    test('should accept timestamps within threshold in strict mode', () => {
        const strictHlc = new HLC('strict-node', { strictMode: true, maxDriftMs: 10000 });
        const currentTime = 1000000;
        jest.spyOn(Date, 'now').mockImplementation(() => currentTime);

        const remote: Timestamp = {
            millis: currentTime + 5000, // 5 seconds ahead, within 10s threshold
            counter: 0,
            nodeId: 'remote-node'
        };

        expect(() => strictHlc.update(remote)).not.toThrow();

        // Verify timestamp was accepted
        const ts = strictHlc.now();
        expect(ts.millis).toBe(currentTime + 5000);
    });

    test('should use default maxDriftMs of 60000 when not specified', () => {
        const strictHlc = new HLC('strict-node', { strictMode: true });
        const currentTime = 1000000;
        jest.spyOn(Date, 'now').mockImplementation(() => currentTime);

        // 50 seconds ahead - within default 60s threshold
        const withinThreshold: Timestamp = {
            millis: currentTime + 50000,
            counter: 0,
            nodeId: 'remote'
        };
        expect(() => strictHlc.update(withinThreshold)).not.toThrow();

        // 70 seconds ahead - exceeds default 60s threshold
        const exceedsThreshold: Timestamp = {
            millis: currentTime + 70000,
            counter: 0,
            nodeId: 'remote'
        };
        expect(() => strictHlc.update(exceedsThreshold)).toThrow('Clock drift detected');
    });

    test('should warn but accept in non-strict mode (default)', () => {
        const consoleWarnSpy = jest.spyOn(console, 'warn').mockImplementation();
        const hlc = new HLC('permissive-node'); // strictMode defaults to false
        const currentTime = 1000000;
        jest.spyOn(Date, 'now').mockImplementation(() => currentTime);

        const remote: Timestamp = {
            millis: currentTime + 100000, // 100 seconds ahead
            counter: 0,
            nodeId: 'remote-node'
        };

        // Should NOT throw
        expect(() => hlc.update(remote)).not.toThrow();

        // Should have warned
        expect(consoleWarnSpy).toHaveBeenCalledWith(
            expect.stringContaining('Clock drift detected')
        );

        // Timestamp should have been accepted
        const ts = hlc.now();
        expect(ts.millis).toBe(currentTime + 100000);

        consoleWarnSpy.mockRestore();
    });

    test('should expose configuration via getters', () => {
        const hlc1 = new HLC('node-1', { strictMode: true, maxDriftMs: 30000 });
        expect(hlc1.getStrictMode).toBe(true);
        expect(hlc1.getMaxDriftMs).toBe(30000);

        const hlc2 = new HLC('node-2'); // defaults
        expect(hlc2.getStrictMode).toBe(false);
        expect(hlc2.getMaxDriftMs).toBe(60000);
    });

    test('should handle negative drift (remote behind local) without strict mode issues', () => {
        const strictHlc = new HLC('strict-node', { strictMode: true, maxDriftMs: 5000 });
        const currentTime = 1000000;
        jest.spyOn(Date, 'now').mockImplementation(() => currentTime);

        const remote: Timestamp = {
            millis: currentTime - 100000, // 100 seconds BEHIND (not ahead)
            counter: 0,
            nodeId: 'remote-node'
        };

        // Negative drift should not trigger rejection (only future drift is problematic)
        expect(() => strictHlc.update(remote)).not.toThrow();
    });
});
```

Also update the import at the top of the file to include HLCOptions:
```typescript
import { HLC, Timestamp, HLCOptions } from '../HLC';
```

Note: The existing "Clock Drift Detection" test (line 348-375) tests the default non-strict behavior and should still pass.
</action>

<verify>
- All HLC tests pass: `cd packages/core && pnpm test -- --testPathPattern="HLC"`
- Specifically strict mode tests pass
</verify>

<done>All HLC tests pass including new strict mode tests covering rejection, acceptance within threshold, default values, and backwards compatibility</done>
</task>

## Verification

After all tasks complete:

1. Build passes: `pnpm --filter @topgunbuild/core build`
2. All core tests pass: `pnpm --filter @topgunbuild/core test`
3. HLC tests specifically: `pnpm --filter @topgunbuild/core test -- --testPathPattern="HLC"`
4. Existing code using HLC without options should continue working unchanged

## Success Criteria

- [x] HLC can be configured with strict mode that rejects timestamps beyond drift threshold
- [x] Default behavior unchanged (warn but accept)
- [x] Drift threshold is configurable (default 60000ms)
- [x] Error messages include actual drift and threshold values for debugging
- [x] Backwards compatible - existing HLC usage without options continues to work
