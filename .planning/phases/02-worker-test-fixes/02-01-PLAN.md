---
phase: 02-worker-test-fixes
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/tsup.config.ts
  - packages/server/jest.config.js
  - packages/server/package.json
autonomous: true
user_setup: []

must_haves:
  truths:
    - "Worker scripts are compiled to JavaScript during build"
    - "Jest tests use compiled .js worker scripts, not .ts"
    - "pnpm test:workers builds first then runs worker tests"
  artifacts:
    - path: "packages/server/tsup.config.ts"
      provides: "Updated build config including worker scripts"
      contains: "worker-scripts"
    - path: "packages/server/jest.config.js"
      provides: "Jest config with globalSetup for worker tests"
      exports: ["preset", "testEnvironment"]
    - path: "packages/server/package.json"
      provides: "test:workers script"
      contains: "test:workers"
  key_links:
    - from: "packages/server/tsup.config.ts"
      to: "packages/server/dist/worker-scripts/"
      via: "tsup build entry points"
      pattern: "src/workers/worker-scripts"
    - from: "packages/server/jest.config.js"
      to: "WorkerPool.resolveWorkerScript()"
      via: "compiled .js files take precedence"
      pattern: "globalSetup|setupFilesAfterEnv"
---

<objective>
Configure build and test infrastructure to compile worker scripts to JavaScript before running worker tests.

Purpose: The root cause of all skipped worker tests is ts-node's inability to load TypeScript files in worker_threads. By pre-compiling workers and ensuring Jest uses the compiled versions, all worker tests will be able to run.

Output: Updated tsup.config.ts, jest.config.js, and package.json with infrastructure to build workers before tests.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worker-test-fixes/02-RESEARCH.md

# Key files
@packages/server/tsup.config.ts
@packages/server/jest.config.js
@packages/server/package.json
@packages/server/src/workers/WorkerPool.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update tsup config to compile worker scripts</name>
  <files>packages/server/tsup.config.ts</files>
  <action>
Add worker script entry points to tsup config so they get compiled to dist/worker-scripts/*.js:

1. Add entry points for all worker scripts:
   - src/workers/worker-scripts/base.worker.ts
   - src/workers/worker-scripts/crdt.worker.ts
   - src/workers/worker-scripts/merkle.worker.ts
   - src/workers/worker-scripts/serialization.worker.ts

2. Keep format as CJS only for worker scripts (Node.js worker_threads require .js files)

3. Ensure the output preserves directory structure so WorkerPool.resolveWorkerScript() can find them at dist/worker-scripts/base.worker.js

Example structure:
```typescript
import { defineConfig } from 'tsup';

export default defineConfig([
  // Main entry points
  {
    entry: ['src/index.ts', 'src/start-server.ts'],
    format: ['cjs', 'esm'],
    dts: true,
    clean: true,
    sourcemap: true,
    external: ['@topgunbuild/native', 'isolated-vm'],
  },
  // Worker scripts - CJS only, preserve directory structure
  {
    entry: ['src/workers/worker-scripts/*.worker.ts'],
    format: ['cjs'],
    outDir: 'dist/workers/worker-scripts',
    clean: false,  // Don't clean, main build already did
    sourcemap: true,
    external: ['@topgunbuild/native', 'isolated-vm'],
  },
]);
```
  </action>
  <verify>
Run `pnpm --filter @topgunbuild/server build` and confirm:
- dist/workers/worker-scripts/base.worker.js exists
- dist/workers/worker-scripts/crdt.worker.js exists
- dist/workers/worker-scripts/merkle.worker.js exists
- dist/workers/worker-scripts/serialization.worker.js exists
  </verify>
  <done>All worker scripts compile to dist/workers/worker-scripts/*.js during build</done>
</task>

<task type="auto">
  <name>Task 2: Add test:workers script with build step</name>
  <files>packages/server/package.json</files>
  <action>
Add a test:workers script that builds first, then runs worker tests:

```json
"scripts": {
  "build": "tsup",
  "test": "jest",
  "test:coverage": "jest --coverage",
  "test:workers": "pnpm build && jest --testPathPattern=workers",
  "test:integration": "jest --config jest.integration.config.js --runInBand",
  "test:integration:distributed": "jest --config jest.integration.config.js --testPathPattern=distributed-subscriptions --runInBand"
}
```

This ensures worker scripts are compiled before any tests that use worker threads run.
  </action>
  <verify>
Run `pnpm --filter @topgunbuild/server test:workers` and confirm it:
1. Runs the build step
2. Runs tests matching "workers" pattern
  </verify>
  <done>test:workers script exists and runs build before worker tests</done>
</task>

<task type="auto">
  <name>Task 3: Update Jest globalSetup to ensure build before worker tests</name>
  <files>packages/server/jest.config.js</files>
  <action>
Modify Jest config to ensure the build output exists when running tests. Add a check that logs a warning if dist/workers/worker-scripts doesn't exist:

1. Add setupFilesAfterEnv pointing to a setup file that validates worker scripts exist

2. Create packages/server/jest.setup.js:
```javascript
// Jest setup: Validate worker scripts are compiled
const fs = require('fs');
const path = require('path');

const workerScriptPath = path.join(__dirname, 'dist', 'workers', 'worker-scripts', 'base.worker.js');

if (!fs.existsSync(workerScriptPath)) {
  console.warn('\n[WARN] Worker scripts not compiled. Run "pnpm build" first for worker thread tests.\n');
  console.warn('Worker thread tests will be skipped until build completes.\n');
}
```

3. Update jest.config.js to include setupFilesAfterEnv:
```javascript
module.exports = {
  // ... existing config
  setupFilesAfterEnv: ['<rootDir>/jest.setup.js'],
};
```

This provides a helpful warning without failing tests, since inline worker tests still work without compilation.
  </action>
  <verify>
1. Run `pnpm --filter @topgunbuild/server test` WITHOUT building first - should see warning
2. Run `pnpm --filter @topgunbuild/server build && pnpm test` - no warning
  </verify>
  <done>Jest warns if worker scripts not compiled, guiding developers to run build first</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. Build succeeds with worker scripts:
```bash
cd packages/server && pnpm build
ls -la dist/workers/worker-scripts/
# Should show: base.worker.js, crdt.worker.js, merkle.worker.js, serialization.worker.js
```

2. test:workers script works:
```bash
cd packages/server && pnpm test:workers
# Should build first, then run worker tests
```

3. WorkerPool resolves to .js files after build:
```bash
# After build, WorkerPool.resolveWorkerScript() should return .js path
node -e "
const { join } = require('path');
const jsPath = join(__dirname, 'packages/server/dist/workers/worker-scripts/base.worker.js');
const fs = require('fs');
console.log('Worker script exists:', fs.existsSync(jsPath));
"
```
</verification>

<success_criteria>
1. tsup builds worker scripts to dist/workers/worker-scripts/*.js
2. package.json has test:workers script that builds then tests
3. Jest setup warns when worker scripts not compiled
4. WorkerPool uses compiled .js files when they exist
</success_criteria>

<output>
After completion, create `.planning/phases/02-worker-test-fixes/02-01-SUMMARY.md`
</output>
