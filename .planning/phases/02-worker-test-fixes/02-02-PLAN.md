---
phase: 02-worker-test-fixes
plan: 02
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/server/src/__tests__/workers/CRDTMergeWorker.test.ts
  - packages/server/src/__tests__/workers/MerkleWorker.test.ts
  - packages/server/src/__tests__/workers/SerializationWorker.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "CRDTMergeWorker tests run without test.skip"
    - "MerkleWorker tests run without test.skip"
    - "SerializationWorker tests run without describe.skip"
    - "All worker tests pass when run via pnpm test:workers"
  artifacts:
    - path: "packages/server/src/__tests__/workers/CRDTMergeWorker.test.ts"
      provides: "Unskipped LWW and ORMap large batch tests"
      min_lines: 400
    - path: "packages/server/src/__tests__/workers/MerkleWorker.test.ts"
      provides: "Unskipped large batch, rebuild, and performance tests"
      min_lines: 300
    - path: "packages/server/src/__tests__/workers/SerializationWorker.test.ts"
      provides: "Unskipped worker thread operations describe block"
      min_lines: 350
  key_links:
    - from: "packages/server/src/__tests__/workers/*.test.ts"
      to: "packages/server/dist/workers/worker-scripts/*.js"
      via: "WorkerPool loads compiled workers"
      pattern: "it\\("
---

<objective>
Unskip all worker thread tests now that infrastructure compiles worker scripts to JavaScript.

Purpose: With plan 02-01 complete, worker scripts are compiled to .js files that Node.js worker_threads can load. The skipped tests can now run.

Output: All worker tests unskipped and passing. Requirements BUG-01, BUG-02, BUG-03 satisfied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worker-test-fixes/02-01-SUMMARY.md

# Test files to modify
@packages/server/src/__tests__/workers/CRDTMergeWorker.test.ts
@packages/server/src/__tests__/workers/MerkleWorker.test.ts
@packages/server/src/__tests__/workers/SerializationWorker.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Unskip CRDTMergeWorker tests (BUG-01)</name>
  <files>packages/server/src/__tests__/workers/CRDTMergeWorker.test.ts</files>
  <action>
Remove the skip from the two worker thread tests:

1. Line 182: Change `it.skip('should handle large batches (worker thread)'` to `it('should handle large batches (worker thread)'`

2. Line 371: Change `it.skip('should handle large batches (worker thread)'` to `it('should handle large batches (worker thread)'`

3. Remove or update comments that say "Skip worker thread tests in Jest" to explain they now require build:
```typescript
// Worker thread tests require pre-compiled workers (pnpm build first)
// Run: pnpm test:workers for full coverage
```

4. Ensure test timeouts are sufficient (15000ms as currently set is good)
  </action>
  <verify>
Run `pnpm --filter @topgunbuild/server test:workers -- --testPathPattern=CRDTMergeWorker`
All tests should pass including the two previously skipped "large batches (worker thread)" tests.
  </verify>
  <done>CRDTMergeWorker has no test.skip, all tests pass including worker thread tests</done>
</task>

<task type="auto">
  <name>Task 2: Unskip MerkleWorker tests (BUG-02)</name>
  <files>packages/server/src/__tests__/workers/MerkleWorker.test.ts</files>
  <action>
Remove the skip from the three worker thread tests:

1. Line 100: Change `it.skip('should handle large batches (worker thread)'` to `it('should handle large batches (worker thread)'`

2. Line 223: Change `it.skip('should handle large rebuilds (worker thread)'` to `it('should handle large rebuilds (worker thread)'`

3. Line 288: Change `it.skip('should handle 10,000+ entries'` to `it('should handle 10,000+ entries'`

4. Update comments explaining the requirement:
```typescript
// Worker thread tests require pre-compiled workers (pnpm build first)
// Run: pnpm test:workers for full coverage
```

5. The 10,000+ entries test has 30000ms timeout which is appropriate for performance tests.
  </action>
  <verify>
Run `pnpm --filter @topgunbuild/server test:workers -- --testPathPattern=MerkleWorker`
All tests should pass including the three previously skipped tests.
  </verify>
  <done>MerkleWorker has no test.skip, all tests pass including worker thread and performance tests</done>
</task>

<task type="auto">
  <name>Task 3: Unskip SerializationWorker tests (BUG-03)</name>
  <files>packages/server/src/__tests__/workers/SerializationWorker.test.ts</files>
  <action>
Remove the skip from the entire describe block:

1. Line 334: Change `describe.skip('Worker Thread Operations'` to `describe('Worker Thread Operations'`

2. Update the file header comment to remove the note about skipping:
```typescript
/**
 * SerializationWorker Tests
 * Phase 1.07: SerializationWorker Implementation
 *
 * Tests for serialization/deserialization operations.
 * Worker thread tests require pre-compiled workers (pnpm build first).
 * Run: pnpm test:workers for full coverage including worker thread tests.
 */
```

3. Add appropriate timeout to the worker thread tests if not already present (15000ms should be sufficient).
  </action>
  <verify>
Run `pnpm --filter @topgunbuild/server test:workers -- --testPathPattern=SerializationWorker`
All tests should pass including the "Worker Thread Operations" describe block.
  </verify>
  <done>SerializationWorker has no describe.skip, all tests pass including worker thread operations</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No skipped tests in worker files:
```bash
grep -r "\.skip\(" packages/server/src/__tests__/workers/*.test.ts
# Should return no matches
```

2. Full worker test suite passes:
```bash
cd packages/server && pnpm test:workers
# All tests should pass
```

3. Count tests run:
```bash
cd packages/server && pnpm test:workers 2>&1 | grep -E "Tests:|Suites:"
# Should show all tests passing, 0 skipped
```

4. Individual test verification:
```bash
cd packages/server && pnpm test:workers -- --testPathPattern=CRDTMergeWorker --verbose 2>&1 | grep -E "(PASS|FAIL|large batches)"
cd packages/server && pnpm test:workers -- --testPathPattern=MerkleWorker --verbose 2>&1 | grep -E "(PASS|FAIL|large|10,000)"
cd packages/server && pnpm test:workers -- --testPathPattern=SerializationWorker --verbose 2>&1 | grep -E "(PASS|FAIL|Worker Thread)"
```
</verification>

<success_criteria>
1. CRDTMergeWorker.test.ts: 0 skipped tests, "large batches (worker thread)" tests pass (BUG-01)
2. MerkleWorker.test.ts: 0 skipped tests, all worker thread and performance tests pass (BUG-02)
3. SerializationWorker.test.ts: 0 skipped tests, "Worker Thread Operations" tests pass (BUG-03)
4. `pnpm test:workers` runs all worker tests with 0 failures
</success_criteria>

<output>
After completion, create `.planning/phases/02-worker-test-fixes/02-02-SUMMARY.md`
</output>
