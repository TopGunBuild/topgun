---
phase: 02-worker-test-fixes
plan: 03
type: execute
wave: 2
depends_on: ["02-01"]
files_modified:
  - packages/server/src/__tests__/DistributedSearch.e2e.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "DistributedSearch E2E test runs without describe.skip"
    - "Test authenticates using proper JWT (not plain string token)"
    - "All E2E tests pass when run via pnpm test:workers"
  artifacts:
    - path: "packages/server/src/__tests__/DistributedSearch.e2e.test.ts"
      provides: "Working E2E distributed search tests"
      min_lines: 280
  key_links:
    - from: "packages/server/src/__tests__/DistributedSearch.e2e.test.ts"
      to: "ServerCoordinator"
      via: "JWT authentication with jwtSecret config"
      pattern: "jwt\\.sign|JWT_SECRET|jwtSecret"
    - from: "DistributedSearch.e2e.test.ts search()"
      to: "ServerCoordinator auth handler"
      via: "AUTH message with valid JWT token"
      pattern: "createTestToken|jwt\\.sign"
---

<objective>
Fix DistributedSearch E2E test to run without skip by implementing proper JWT authentication.

Purpose: The E2E test is skipped because it uses `'test-token'` string instead of a proper JWT. The working distributed-subscriptions.integration.test.ts shows the correct pattern using jwt.sign() with a shared secret.

Output: DistributedSearch E2E test unskipped and passing. Requirement BUG-04 satisfied.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-worker-test-fixes/02-01-SUMMARY.md
@.planning/phases/02-worker-test-fixes/02-RESEARCH.md

# Reference: Working integration test pattern
@packages/server/src/__tests__/integration/distributed-subscriptions.integration.test.ts

# File to fix
@packages/server/src/__tests__/DistributedSearch.e2e.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add JWT auth infrastructure to DistributedSearch E2E</name>
  <files>packages/server/src/__tests__/DistributedSearch.e2e.test.ts</files>
  <action>
Add proper JWT authentication following the pattern from distributed-subscriptions.integration.test.ts:

1. Add jsonwebtoken import:
```typescript
import jwt from 'jsonwebtoken';
```

2. Add JWT_SECRET constant (must match server config):
```typescript
const JWT_SECRET = 'test-secret-for-e2e-tests';
```

3. Add createTestToken helper function:
```typescript
// Helper: Create a valid JWT token with ADMIN role for full access
function createTestToken(userId = 'test-user', roles = ['ADMIN']): string {
  return jwt.sign({ userId, roles }, JWT_SECRET, { expiresIn: '1h' });
}
```

4. Update the search() helper function to use createTestToken() instead of 'test-token':
```typescript
client.send(serialize({
  type: 'AUTH',
  token: createTestToken(),  // Changed from 'test-token'
}));
```

5. Update ServerCoordinator initialization to include jwtSecret:
```typescript
node1 = new ServerCoordinator({
  port: 0,
  nodeId: 'search-node-1',
  host: 'localhost',
  clusterPort: 0,
  peers: [],
  jwtSecret: JWT_SECRET,  // Add this
  fullTextSearch: {
    articles: {
      fields: ['title', 'content'],
    },
  },
});
```

Apply the same jwtSecret config to node2 and singleNode in their respective beforeAll blocks.
  </action>
  <verify>
Check the file has:
- `import jwt from 'jsonwebtoken'`
- `const JWT_SECRET =`
- `function createTestToken`
- `jwtSecret: JWT_SECRET` in all ServerCoordinator configs
- `token: createTestToken()` in the AUTH message
  </verify>
  <done>JWT authentication infrastructure added to DistributedSearch E2E test</done>
</task>

<task type="auto">
  <name>Task 2: Unskip and run DistributedSearch E2E test (BUG-04)</name>
  <files>packages/server/src/__tests__/DistributedSearch.e2e.test.ts</files>
  <action>
1. Remove the describe.skip on line 21:
```typescript
// Before:
describe.skip('Distributed Search E2E', () => {

// After:
describe('Distributed Search E2E', () => {
```

2. Update the file header comment to remove skip note:
```typescript
/**
 * E2E Distributed Search Tests
 *
 * Tests real distributed search across multiple server nodes:
 * - Multi-node FTS search with RRF merge
 * - Single-node FTS fallback
 * - Search result ranking across nodes
 * - Cursor-based pagination
 *
 * Run: pnpm test:workers -- --testPathPattern=DistributedSearch --runInBand
 */
```

3. Increase timeouts if needed:
- beforeAll timeout: 30000ms (cluster formation can be slow)
- Individual test timeouts: 15000ms (already set, should be fine)

4. Add runInBand requirement note since E2E tests should run sequentially:
```typescript
// Run: npx jest --testPathPattern="DistributedSearch.e2e" --runInBand
```
  </action>
  <verify>
Run `pnpm --filter @topgunbuild/server build && pnpm --filter @topgunbuild/server test -- --testPathPattern=DistributedSearch --runInBand`
All tests should pass.
  </verify>
  <done>DistributedSearch E2E test runs without skip, all tests pass</done>
</task>

</tasks>

<verification>
After all tasks complete:

1. No skipped tests in DistributedSearch:
```bash
grep -E "describe\.skip|it\.skip" packages/server/src/__tests__/DistributedSearch.e2e.test.ts
# Should return no matches
```

2. JWT auth is properly configured:
```bash
grep -E "jwt\\.sign|JWT_SECRET|jwtSecret|createTestToken" packages/server/src/__tests__/DistributedSearch.e2e.test.ts
# Should show JWT_SECRET constant, createTestToken function, and jwtSecret in server configs
```

3. E2E test passes:
```bash
cd packages/server && pnpm build && pnpm test -- --testPathPattern=DistributedSearch --runInBand --verbose
# All tests should pass
```

4. Check auth works (from test output):
```bash
# Test output should NOT show "AUTH_FAIL" or "unauthorized" errors
```
</verification>

<success_criteria>
1. DistributedSearch.e2e.test.ts: 0 skipped tests
2. JWT authentication properly configured (jwt.sign with shared secret)
3. ServerCoordinator instances have jwtSecret config matching test token
4. All E2E tests pass when run with --runInBand
5. BUG-04 requirement satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/02-worker-test-fixes/02-03-SUMMARY.md`
</output>
