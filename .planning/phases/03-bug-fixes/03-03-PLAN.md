---
phase: 03-bug-fixes
plan: 03
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/ServerCoordinator.ts
autonomous: true

must_haves:
  truths:
    - "getMapAsync debug logs only appear when TOPGUN_DEBUG=true"
    - "getMapAsync debug logs do NOT appear when TOPGUN_DEBUG is unset"
    - "Production log output is not polluted with [getMapAsync] messages"
  artifacts:
    - path: "packages/server/src/ServerCoordinator.ts"
      provides: "Debug-gated logging in getMapAsync"
      contains: "TOPGUN_DEBUG"
  key_links:
    - from: "getMapAsync logger.info calls"
      to: "process.env.TOPGUN_DEBUG"
      via: "conditional check"
      pattern: "TOPGUN_DEBUG.*true"
---

# 03-03: Debug Logging Gating

**Objective:** Gate verbose debug logging in `getMapAsync` behind the `TOPGUN_DEBUG` environment variable.

**Requirements:** BUG-07

## Context

@.planning/phases/03-bug-fixes/03-RESEARCH.md (BUG-07 section)
@packages/server/src/ServerCoordinator.ts (lines 4251-4268: debug logging)

## Tasks

<task id="1">
<title>Gate getMapAsync debug logs behind TOPGUN_DEBUG</title>
<instructions>
Modify `packages/server/src/ServerCoordinator.ts`:

1. Locate the `getMapAsync` method (around line 4242).

2. Replace the unconditional debug logging with TOPGUN_DEBUG-gated logging. The current code at lines 4251-4268:

```typescript
// [DEBUG] Log state for troubleshooting sync issues
const map = this.maps.get(name);
const mapSize = map instanceof LWWMap ? Array.from(map.entries()).length :
               map instanceof ORMap ? map.size : 0;
logger.info({
    mapName: name,
    mapExisted,
    hasLoadingPromise: !!loadingPromise,
    currentMapSize: mapSize
}, '[getMapAsync] State check');

if (loadingPromise) {
    logger.info({ mapName: name }, '[getMapAsync] Waiting for loadMapFromStorage...');
    await loadingPromise;
    const newMapSize = map instanceof LWWMap ? Array.from(map.entries()).length :
                      map instanceof ORMap ? map.size : 0;
    logger.info({ mapName: name, mapSizeAfterLoad: newMapSize }, '[getMapAsync] Load completed');
}
```

Should become:

```typescript
// Debug logging gated behind TOPGUN_DEBUG
const debugEnabled = process.env.TOPGUN_DEBUG === 'true';

if (debugEnabled) {
    const map = this.maps.get(name);
    const mapSize = map instanceof LWWMap ? Array.from(map.entries()).length :
                   map instanceof ORMap ? map.size : 0;
    logger.info({
        mapName: name,
        mapExisted,
        hasLoadingPromise: !!loadingPromise,
        currentMapSize: mapSize
    }, '[getMapAsync] State check');
}

if (loadingPromise) {
    if (debugEnabled) {
        logger.info({ mapName: name }, '[getMapAsync] Waiting for loadMapFromStorage...');
    }
    await loadingPromise;
    if (debugEnabled) {
        const map = this.maps.get(name);
        const newMapSize = map instanceof LWWMap ? Array.from(map.entries()).length :
                          map instanceof ORMap ? map.size : 0;
        logger.info({ mapName: name, mapSizeAfterLoad: newMapSize }, '[getMapAsync] Load completed');
    }
}
```

3. Remove the old `// [DEBUG]` comment as the code is now self-documenting.

4. Note: We check `process.env.TOPGUN_DEBUG === 'true'` inside the method rather than caching as a class field because:
   - Environment variables can be changed at runtime in some scenarios
   - The performance cost of the string comparison is negligible compared to the avoided object creation and logging when disabled
   - Keeps the change localized and simple

5. Verify the build: `pnpm --filter @topgunbuild/server build`
</instructions>
<acceptance>
- [ ] All three `logger.info` calls in `getMapAsync` are wrapped with `if (debugEnabled)` or `if (process.env.TOPGUN_DEBUG === 'true')`
- [ ] Map size calculations only happen inside debug condition (no wasted CPU when debug disabled)
- [ ] TypeScript compiles: `pnpm --filter @topgunbuild/server build`
</acceptance>
</task>

<task id="2">
<title>Manual verification of debug gating</title>
<instructions>
This task verifies the logging behavior manually since environment-dependent logging is difficult to unit test cleanly.

1. Build the server package:
```bash
pnpm --filter @topgunbuild/server build
```

2. Create a simple test script to verify the behavior. The change can be verified by:

   a. Start server WITHOUT TOPGUN_DEBUG and observe logs:
   ```bash
   # In one terminal
   cd packages/server
   LOG_LEVEL=info node -e "
     const { ServerCoordinator } = require('./dist');
     const server = new ServerCoordinator({ port: 19999, jwtSecret: 'test-secret-key-at-least-32-chars!!' });
     server.start().then(() => {
       // Trigger getMapAsync
       server.getMapAsync('test-map').then(() => {
         console.log('Done - check logs above for [getMapAsync] messages');
         server.stop();
         process.exit(0);
       });
     });
   "
   ```
   Expected: NO `[getMapAsync]` log messages

   b. Start server WITH TOPGUN_DEBUG=true and observe logs:
   ```bash
   TOPGUN_DEBUG=true LOG_LEVEL=info node -e "
     const { ServerCoordinator } = require('./dist');
     const server = new ServerCoordinator({ port: 19999, jwtSecret: 'test-secret-key-at-least-32-chars!!' });
     server.start().then(() => {
       server.getMapAsync('test-map').then(() => {
         console.log('Done - check logs above for [getMapAsync] messages');
         server.stop();
         process.exit(0);
       });
     });
   "
   ```
   Expected: `[getMapAsync] State check` log message appears

3. Ensure existing server tests still pass:
```bash
pnpm --filter @topgunbuild/server test -- --testPathPattern=ServerCoordinator --runInBand
```

Note: If ServerCoordinator tests take too long or have flaky behavior, just run the build verification. The change is minimal and low-risk.
</instructions>
<acceptance>
- [ ] Server builds successfully
- [ ] Without TOPGUN_DEBUG, no `[getMapAsync]` log messages appear
- [ ] With TOPGUN_DEBUG=true, `[getMapAsync]` log messages appear
- [ ] Existing server tests pass (or are not broken by this change)
</acceptance>
</task>

## Verification

<verification>
<command>pnpm --filter @topgunbuild/server build</command>
<expected>Build succeeds with no TypeScript errors</expected>
</verification>

## must_haves

These are derived from the phase goal. If any is FALSE after execution, the plan has FAILED:

- [ ] `getMapAsync` debug logs are guarded by `process.env.TOPGUN_DEBUG === 'true'`
- [ ] No `[getMapAsync]` log output in production (TOPGUN_DEBUG unset)
- [ ] Debug logs still available when `TOPGUN_DEBUG=true` for troubleshooting

## Success Criteria

- Production logs are not polluted with getMapAsync debug output
- Debug output remains available for troubleshooting when explicitly enabled
- Server package builds without errors
