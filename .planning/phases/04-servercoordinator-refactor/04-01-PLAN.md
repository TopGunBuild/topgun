---
phase: 04-servercoordinator-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/coordinator/types.ts
  - packages/server/src/coordinator/auth-handler.ts
  - packages/server/src/coordinator/index.ts
  - packages/server/src/ServerCoordinator.ts
autonomous: true

must_haves:
  truths:
    - "AUTH message handling is delegated to AuthHandler"
    - "JWT verification logic lives in AuthHandler, not ServerCoordinator"
    - "AuthHandler is stateless (no connection state)"
    - "Existing auth tests continue to pass"
  artifacts:
    - path: "packages/server/src/coordinator/types.ts"
      provides: "Shared interfaces for coordinator modules"
      contains: "interface IAuthHandler"
    - path: "packages/server/src/coordinator/auth-handler.ts"
      provides: "AuthHandler implementation"
      exports: ["AuthHandler"]
    - path: "packages/server/src/coordinator/index.ts"
      provides: "Barrel exports for coordinator modules"
      exports: ["AuthHandler", "IAuthHandler"]
  key_links:
    - from: "packages/server/src/ServerCoordinator.ts"
      to: "packages/server/src/coordinator/auth-handler.ts"
      via: "import and instantiation"
      pattern: "new AuthHandler"
    - from: "packages/server/src/ServerCoordinator.ts"
      to: "auth-handler.handleAuth"
      via: "delegation in handleMessage"
      pattern: "this\\.authHandler\\.handleAuth"
---

<objective>
Extract AuthHandler module from ServerCoordinator

Purpose: Begin the refactoring by extracting the stateless auth logic (JWT verification, AUTH message handling) into a dedicated AuthHandler module. This establishes the coordinator/ folder structure and types.ts pattern for subsequent extractions.

Output: AuthHandler class in coordinator/auth-handler.ts, shared types in coordinator/types.ts, barrel exports in coordinator/index.ts, ServerCoordinator updated to use AuthHandler
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-servercoordinator-refactor/04-RESEARCH.md
@.planning/phases/04-servercoordinator-refactor/04-CONTEXT.md
@packages/server/src/ServerCoordinator.ts (lines 1-200 for imports/config, 1401-1442 for AUTH handling)
@packages/server/src/handlers/CounterHandler.ts (pattern reference)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create coordinator folder with types and AuthHandler</name>
  <files>
    packages/server/src/coordinator/types.ts
    packages/server/src/coordinator/auth-handler.ts
    packages/server/src/coordinator/index.ts
  </files>
  <action>
Create the coordinator/ folder structure:

1. **types.ts** - Define shared interfaces:
   - `ClientConnection` interface (copy from ServerCoordinator line 58-67)
   - `IAuthHandler` interface with:
     - `verifyToken(token: string): Principal` - Verify JWT and return principal
     - `handleAuth(client: ClientConnection, token: string): Promise<AuthResult>` - Handle AUTH message
   - `AuthResult` type: `{ success: boolean; principal?: Principal; error?: string }`
   - `AuthHandlerConfig` interface with:
     - `jwtSecret: string`
     - `onAuthSuccess?: (clientId: string, principal: Principal) => void`
     - `onAuthFailure?: (clientId: string, error: string) => void`

2. **auth-handler.ts** - Implement AuthHandler class:
   - Constructor takes `AuthHandlerConfig`
   - Store jwtSecret and callbacks as private readonly
   - Extract JWT verification logic from ServerCoordinator lines 1406-1419:
     - Support both HS256 (symmetric) and RS256 (asymmetric/Clerk)
     - Normalize principal (add default roles, map sub to userId)
   - `verifyToken(token)`: Pure JWT verification, throws on failure
   - `handleAuth(client, token)`: Calls verifyToken, updates client state, calls callbacks
   - Use existing `logger` from '../utils/logger'
   - Use `jsonwebtoken` library (already imported in ServerCoordinator)

3. **index.ts** - Barrel exports:
   - Export `AuthHandler` from './auth-handler'
   - Export `IAuthHandler`, `AuthHandlerConfig`, `AuthResult`, `ClientConnection` from './types'
  </action>
  <verify>
    - `ls packages/server/src/coordinator/` shows types.ts, auth-handler.ts, index.ts
    - `npx tsc --noEmit -p packages/server/tsconfig.json` passes (no type errors)
  </verify>
  <done>
    coordinator/ folder exists with types.ts, auth-handler.ts, index.ts
    All files compile without TypeScript errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate AuthHandler into ServerCoordinator</name>
  <files>packages/server/src/ServerCoordinator.ts</files>
  <action>
Update ServerCoordinator to use the new AuthHandler:

1. **Add imports** at top of file:
   ```typescript
   import { AuthHandler, ClientConnection as CoordinatorClientConnection } from './coordinator';
   ```
   Note: Keep local ClientConnection interface for now (will be removed in Plan 02 when ConnectionManager owns it)

2. **Add private field** in class (around line 260):
   ```typescript
   private authHandler: AuthHandler;
   ```

3. **Initialize in constructor** (after jwtSecret is set, around line 308):
   ```typescript
   this.authHandler = new AuthHandler({
     jwtSecret: this.jwtSecret,
     onAuthSuccess: (clientId, principal) => {
       // Mark connection as established (handshake complete)
       if (this.rateLimitingEnabled) {
         this.rateLimiter.onConnectionEstablished();
       }
     },
   });
   ```

4. **Update handleMessage AUTH handling** (lines 1401-1442):
   Replace the inline JWT verification with:
   ```typescript
   if (message.type === 'AUTH') {
     const token = message.token;
     const result = await this.authHandler.handleAuth(client, token);
     if (result.success) {
       client.writer.write({ type: 'AUTH_ACK' }, true);
     } else {
       client.writer.write({ type: 'AUTH_FAIL', error: result.error || 'Invalid token' }, true);
       client.socket.close(4001, 'Unauthorized');
     }
     return;
   }
   ```

5. **Delete the old JWT verification code** (lines 1406-1436) - it's now in AuthHandler

6. **Keep the "Reject any other message before auth" logic** (lines 1437-1441) in ServerCoordinator
  </action>
  <verify>
    - `pnpm --filter @topgunbuild/server build` succeeds
    - `pnpm --filter @topgunbuild/server test -- --testPathPattern="Security"` passes
    - `pnpm --filter @topgunbuild/server test -- --testPathPattern="heartbeat"` passes (uses auth)
  </verify>
  <done>
    ServerCoordinator uses AuthHandler for AUTH message handling
    JWT verification code deleted from ServerCoordinator
    All existing auth-related tests pass
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify extraction and run full test suite</name>
  <files>packages/server/src/coordinator/auth-handler.ts</files>
  <action>
Final verification:

1. **Count lines moved**: The auth handling code (roughly 30 lines) should now be in auth-handler.ts instead of ServerCoordinator

2. **Verify no duplicate code**: Search ServerCoordinator for:
   - `jwt.verify` - should NOT appear (moved to AuthHandler)
   - `decoded.roles` normalization - should NOT appear (moved to AuthHandler)

3. **Run comprehensive tests**:
   ```bash
   pnpm --filter @topgunbuild/server test
   ```

4. **If any test failures**:
   - Check if tests use `(server as any).jwtSecret` or similar internal access
   - Update test to use public API or add test accessor if needed
   - Document any test changes in SUMMARY

5. **Verify AuthHandler is stateless**: The class should have no mutable state (no `this.clients`, no `this.connections`)
  </action>
  <verify>
    - `grep -n "jwt.verify" packages/server/src/ServerCoordinator.ts` returns no matches
    - `pnpm --filter @topgunbuild/server test` all tests pass
  </verify>
  <done>
    No duplicate JWT code in ServerCoordinator
    AuthHandler is stateless (only config, no mutable state)
    All server tests pass
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 1 verification:

1. **Module exists**: `packages/server/src/coordinator/auth-handler.ts` exports `AuthHandler`
2. **Types exist**: `packages/server/src/coordinator/types.ts` exports `IAuthHandler`, `ClientConnection`
3. **Integration complete**: ServerCoordinator imports and uses AuthHandler
4. **No duplicate code**: JWT verification only in AuthHandler, not ServerCoordinator
5. **Tests pass**: `pnpm --filter @topgunbuild/server test` green
</verification>

<success_criteria>
- AuthHandler module created with IAuthHandler interface
- JWT verification logic extracted from ServerCoordinator
- ServerCoordinator delegates AUTH handling to AuthHandler
- coordinator/ folder structure established for subsequent plans
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-servercoordinator-refactor/04-01-SUMMARY.md`
</output>
