---
phase: 04-servercoordinator-refactor
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/server/src/coordinator/types.ts
  - packages/server/src/coordinator/connection-manager.ts
  - packages/server/src/coordinator/index.ts
  - packages/server/src/ServerCoordinator.ts
autonomous: true

must_haves:
  truths:
    - "ConnectionManager owns the clients Map"
    - "Connection registration/removal is delegated to ConnectionManager"
    - "Broadcast functionality lives in ConnectionManager"
    - "Heartbeat check (isClientAlive) lives in ConnectionManager"
    - "Existing connection-related tests continue to pass"
  artifacts:
    - path: "packages/server/src/coordinator/connection-manager.ts"
      provides: "ConnectionManager implementation"
      exports: ["ConnectionManager"]
    - path: "packages/server/src/coordinator/types.ts"
      provides: "IConnectionManager interface"
      contains: "interface IConnectionManager"
  key_links:
    - from: "packages/server/src/ServerCoordinator.ts"
      to: "packages/server/src/coordinator/connection-manager.ts"
      via: "import and instantiation"
      pattern: "new ConnectionManager"
    - from: "packages/server/src/ServerCoordinator.ts"
      to: "connectionManager.getClients"
      via: "delegation for client access"
      pattern: "this\\.connectionManager\\.getClients"
---

<objective>
Extract ConnectionManager module from ServerCoordinator

Purpose: Extract connection lifecycle management (client registration, removal, broadcast) into a dedicated ConnectionManager module. This module is stateful - it owns the clients Map.

Output: ConnectionManager class in coordinator/connection-manager.ts, IConnectionManager interface in types.ts, ServerCoordinator updated to delegate connection operations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-servercoordinator-refactor/04-RESEARCH.md
@.planning/phases/04-servercoordinator-refactor/04-CONTEXT.md
@packages/server/src/ServerCoordinator.ts (lines 188 for clients Map, 1211-1372 for handleConnection, 2932-3103 for broadcast)
@packages/server/src/topic/TopicManager.ts (pattern reference for manager with config)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IConnectionManager interface and ConnectionManager class</name>
  <files>
    packages/server/src/coordinator/types.ts
    packages/server/src/coordinator/connection-manager.ts
    packages/server/src/coordinator/index.ts
  </files>
  <action>
1. **Update types.ts** - Add IConnectionManager interface:
   ```typescript
   export interface IConnectionManager {
     /** Get all connected clients (read-only access) */
     getClients(): Map<string, ClientConnection>;

     /** Get a specific client by ID */
     getClient(clientId: string): ClientConnection | undefined;

     /** Register a new client connection */
     registerClient(clientId: string, socket: WebSocket, writer: CoalescingWriter): ClientConnection;

     /** Remove client and return the removed connection (for cleanup) */
     removeClient(clientId: string): ClientConnection | undefined;

     /** Update client's authenticated state */
     setClientAuthenticated(clientId: string, principal: Principal): void;

     /** Broadcast message to all clients (optionally excluding one) */
     broadcast(message: any, excludeClientId?: string): void;

     /** Broadcast batch of events */
     broadcastBatch(events: any[], excludeClientId?: string): void;

     /** Check if client is alive based on heartbeat */
     isClientAlive(clientId: string): boolean;

     /** Get client idle time in ms */
     getClientIdleTime(clientId: string): number;

     /** Update client's last ping timestamp */
     updateLastPing(clientId: string): void;

     /** Get total client count */
     getClientCount(): number;
   }

   export interface ConnectionManagerConfig {
     hlc: HLC;
     writeCoalescingEnabled: boolean;
     writeCoalescingOptions: Partial<CoalescingWriterOptions>;
     clientHeartbeatTimeoutMs?: number;  // Default: 20000
     onClientRegistered?: (client: ClientConnection) => void;
     onClientRemoved?: (clientId: string) => void;
   }
   ```

2. **Create connection-manager.ts**:
   - Constructor takes `ConnectionManagerConfig`
   - Private `clients: Map<string, ClientConnection>` - this is THE source of truth
   - Extract from ServerCoordinator:
     - `getClients()` - return the clients map (read-only via method)
     - `registerClient()` - creates ClientConnection object (from handleConnection lines 1238-1246)
     - `removeClient()` - deletes from map, returns removed connection
     - `broadcast()` - from lines 2932-2996, iterates clients and writes
     - `broadcastBatch()` - from lines 2997-3103
     - `isClientAlive()` - from lines 4458-4466
     - `getClientIdleTime()` - from lines 4469-4477
   - Use `logger` from '../utils/logger'
   - Import WebSocket from 'ws'

3. **Update index.ts** - Add exports:
   ```typescript
   export { ConnectionManager } from './connection-manager';
   export type { IConnectionManager, ConnectionManagerConfig } from './types';
   ```
  </action>
  <verify>
    - `ls packages/server/src/coordinator/connection-manager.ts` exists
    - `npx tsc --noEmit -p packages/server/tsconfig.json` passes
  </verify>
  <done>
    ConnectionManager class created with IConnectionManager interface
    All connection-related methods extracted
    TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate ConnectionManager into ServerCoordinator</name>
  <files>packages/server/src/ServerCoordinator.ts</files>
  <action>
Update ServerCoordinator to use ConnectionManager:

1. **Update imports**:
   ```typescript
   import { AuthHandler, ConnectionManager } from './coordinator';
   ```

2. **Replace clients Map with ConnectionManager**:
   - Remove: `private clients: Map<string, ClientConnection> = new Map();` (line 188)
   - Add: `private connectionManager: ConnectionManager;`

3. **Initialize in constructor** (after writeCoalescingOptions, around line 340):
   ```typescript
   this.connectionManager = new ConnectionManager({
     hlc: this.hlc,
     writeCoalescingEnabled: this.writeCoalescingEnabled,
     writeCoalescingOptions: this.writeCoalescingOptions,
   });
   ```

4. **Update handleConnection** (lines 1211-1372):
   - Replace direct client creation with:
     ```typescript
     const connection = this.connectionManager.registerClient(clientId, ws, writer);
     ```
   - Replace `this.clients.set(...)` - removed (ConnectionManager handles)
   - Replace `this.clients.delete(...)` with `this.connectionManager.removeClient(clientId)`
   - Replace `this.clients.get(...)` with `this.connectionManager.getClient(...)`
   - Replace `this.clients.size` with `this.connectionManager.getClientCount()`

5. **Update broadcast methods**:
   - Replace `this.broadcast(...)` calls with `this.connectionManager.broadcast(...)`
   - Replace `this.broadcastBatch(...)` calls with `this.connectionManager.broadcastBatch(...)`
   - Delete the old `private broadcast()` method (lines 2932-2996)
   - Delete the old `private broadcastBatch()` method (lines 2997-3103)

6. **Update heartbeat methods**:
   - Replace `this.isClientAlive(...)` with `this.connectionManager.isClientAlive(...)`
   - Replace `this.getClientIdleTime(...)` with `this.connectionManager.getClientIdleTime(...)`
   - Delete old `isClientAlive()` method (lines 4458-4466)
   - Delete old `getClientIdleTime()` method (lines 4469-4477)

7. **Update all `this.clients.get(clientId)` usages** throughout the file:
   - Search for `this.clients.get` and replace with `this.connectionManager.getClient`
   - Search for `this.clients.has` and replace with `this.connectionManager.getClient(...) !== undefined`

8. **Keep metricsService calls** in ServerCoordinator (orchestrator responsibility):
   - `this.metricsService.setConnectedClients(this.connectionManager.getClientCount())`
  </action>
  <verify>
    - `grep -n "private clients:" packages/server/src/ServerCoordinator.ts` returns no matches
    - `pnpm --filter @topgunbuild/server build` succeeds
    - `pnpm --filter @topgunbuild/server test -- --testPathPattern="heartbeat"` passes
  </verify>
  <done>
    ServerCoordinator no longer owns clients Map
    All client access goes through ConnectionManager
    Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify extraction and run full test suite</name>
  <files>packages/server/src/coordinator/connection-manager.ts</files>
  <action>
Final verification:

1. **Verify clients Map ownership**:
   - `grep -n "clients:" packages/server/src/ServerCoordinator.ts` should only show connectionManager usage
   - `grep -n "private clients" packages/server/src/coordinator/connection-manager.ts` shows the Map

2. **Verify no duplicate code**:
   - Old broadcast logic deleted from ServerCoordinator
   - Old heartbeat methods deleted from ServerCoordinator

3. **Run comprehensive tests**:
   ```bash
   pnpm --filter @topgunbuild/server test
   ```

4. **Verify ConnectionManager is the single source of truth** for client state:
   - No other class should have `clients: Map<string, ClientConnection>`
   - All client lookups go through ConnectionManager

5. **Check for bootstrap controller integration** (lines 426-447 use this.clients):
   - Update `getMaps: () => this.maps` and cluster status to use connectionManager
  </action>
  <verify>
    - `grep -rn "private clients:" packages/server/src/` only shows connection-manager.ts
    - `pnpm --filter @topgunbuild/server test` all tests pass
  </verify>
  <done>
    ConnectionManager is the single owner of clients Map
    No duplicate connection logic in ServerCoordinator
    All server tests pass
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 2 verification:

1. **Module exists**: `packages/server/src/coordinator/connection-manager.ts` exports `ConnectionManager`
2. **Interface exists**: `packages/server/src/coordinator/types.ts` exports `IConnectionManager`
3. **Clients Map moved**: ServerCoordinator no longer has `private clients: Map`
4. **Integration complete**: ServerCoordinator uses ConnectionManager for all client operations
5. **Tests pass**: `pnpm --filter @topgunbuild/server test` green
</verification>

<success_criteria>
- ConnectionManager module created with IConnectionManager interface
- clients Map ownership transferred to ConnectionManager
- ServerCoordinator delegates all connection operations to ConnectionManager
- broadcast/broadcastBatch methods moved to ConnectionManager
- heartbeat methods moved to ConnectionManager
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-servercoordinator-refactor/04-02-SUMMARY.md`
</output>
