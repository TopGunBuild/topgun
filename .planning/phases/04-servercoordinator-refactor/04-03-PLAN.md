---
phase: 04-servercoordinator-refactor
plan: 03
type: execute
wave: 2
depends_on: ["04-01"]
files_modified:
  - packages/server/src/coordinator/types.ts
  - packages/server/src/coordinator/storage-manager.ts
  - packages/server/src/coordinator/index.ts
  - packages/server/src/ServerCoordinator.ts
autonomous: true

must_haves:
  truths:
    - "StorageManager owns the maps Map"
    - "getMap/getMapAsync operations are delegated to StorageManager"
    - "loadMapFromStorage lives in StorageManager"
    - "Sync protocol message handling (SYNC_INIT, MERKLE_REQ_BUCKET, etc.) uses StorageManager"
    - "Existing storage and sync tests continue to pass"
  artifacts:
    - path: "packages/server/src/coordinator/storage-manager.ts"
      provides: "StorageManager implementation"
      exports: ["StorageManager"]
    - path: "packages/server/src/coordinator/types.ts"
      provides: "IStorageManager interface"
      contains: "interface IStorageManager"
  key_links:
    - from: "packages/server/src/ServerCoordinator.ts"
      to: "packages/server/src/coordinator/storage-manager.ts"
      via: "import and instantiation"
      pattern: "new StorageManager"
    - from: "packages/server/src/ServerCoordinator.ts"
      to: "storageManager.getMapAsync"
      via: "delegation for map access"
      pattern: "this\\.storageManager\\.getMapAsync"
---

<objective>
Extract StorageManager module from ServerCoordinator

Purpose: Extract map storage management (maps Map, getMap, getMapAsync, loadMapFromStorage) into a dedicated StorageManager module. This module manages in-memory CRDT maps and their persistence loading.

Output: StorageManager class in coordinator/storage-manager.ts, IStorageManager interface in types.ts, ServerCoordinator updated to delegate storage operations
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-servercoordinator-refactor/04-RESEARCH.md
@.planning/phases/04-servercoordinator-refactor/04-CONTEXT.md
@packages/server/src/ServerCoordinator.ts (lines 194 for maps Map, 4213-4285 for getMap, 4242-4340 for getMapAsync, 4342-4420 for loadMapFromStorage)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add IStorageManager interface and StorageManager class</name>
  <files>
    packages/server/src/coordinator/types.ts
    packages/server/src/coordinator/storage-manager.ts
    packages/server/src/coordinator/index.ts
  </files>
  <action>
1. **Update types.ts** - Add IStorageManager interface:
   ```typescript
   import { LWWMap, ORMap, HLC, Timestamp, IndexedLWWMap, IndexedORMap, FullTextIndexConfig } from '@topgunbuild/core';
   import { IServerStorage } from '../storage/IServerStorage';

   export interface IStorageManager {
     /** Get or create a map by name (synchronous, may return empty map while loading) */
     getMap(name: string, typeHint?: 'LWW' | 'OR'): LWWMap<string, any> | ORMap<string, any>;

     /** Get map with async loading guarantee (waits for storage load) */
     getMapAsync(name: string, typeHint?: 'LWW' | 'OR'): Promise<LWWMap<string, any> | ORMap<string, any>>;

     /** Get all maps (for iteration/debug) */
     getMaps(): Map<string, LWWMap<string, any> | ORMap<string, any>>;

     /** Check if a map exists */
     hasMap(name: string): boolean;

     /** Load a map from storage (triggers async load) */
     loadMapFromStorage(name: string, typeHint: 'LWW' | 'OR'): Promise<void>;

     /** Check if map is currently loading */
     isMapLoading(name: string): boolean;
   }

   export interface StorageManagerConfig {
     nodeId: string;
     hlc: HLC;
     storage?: IServerStorage;
     fullTextSearch?: Record<string, FullTextIndexConfig>;
     onMapCreated?: (mapName: string, map: LWWMap<string, any> | ORMap<string, any>) => void;
   }
   ```

2. **Create storage-manager.ts**:
   - Constructor takes `StorageManagerConfig`
   - Private `maps: Map<string, LWWMap<string, any> | ORMap<string, any>>` - THE source of truth
   - Private `mapLoadingPromises: Map<string, Promise<void>>` - track loading state
   - Extract from ServerCoordinator:
     - `getMap()` - from lines 4213-4241
     - `getMapAsync()` - from lines 4242-4285 (includes debug logging with TOPGUN_DEBUG check)
     - `loadMapFromStorage()` - from lines 4342-4420
   - Handle IndexedLWWMap/IndexedORMap creation for full-text search configs
   - Use `logger` from '../utils/logger'
   - Import necessary types from '@topgunbuild/core'

3. **Update index.ts** - Add exports:
   ```typescript
   export { StorageManager } from './storage-manager';
   export type { IStorageManager, StorageManagerConfig } from './types';
   ```
  </action>
  <verify>
    - `ls packages/server/src/coordinator/storage-manager.ts` exists
    - `npx tsc --noEmit -p packages/server/tsconfig.json` passes
  </verify>
  <done>
    StorageManager class created with IStorageManager interface
    All storage-related methods extracted
    TypeScript compiles without errors
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate StorageManager into ServerCoordinator</name>
  <files>packages/server/src/ServerCoordinator.ts</files>
  <action>
Update ServerCoordinator to use StorageManager:

1. **Update imports**:
   ```typescript
   import { AuthHandler, ConnectionManager, StorageManager } from './coordinator';
   ```

2. **Replace maps Map with StorageManager**:
   - Remove: `private maps: Map<string, LWWMap<string, any> | ORMap<string, any>> = new Map();` (line 194)
   - Remove: `private mapLoadingPromises: Map<string, Promise<void>> = new Map();` (line 216)
   - Add: `private storageManager: StorageManager;`

3. **Initialize in constructor** (after hlc initialization):
   ```typescript
   this.storageManager = new StorageManager({
     nodeId: config.nodeId,
     hlc: this.hlc,
     storage: this.storage,
     fullTextSearch: config.fullTextSearch,
   });
   ```

4. **Update getMap/getMapAsync**:
   - Change `public getMap(...)` to delegate: `return this.storageManager.getMap(name, typeHint);`
   - Change `public async getMapAsync(...)` to delegate: `return this.storageManager.getMapAsync(name, typeHint);`
   - Keep the public methods as pass-through (API preservation)
   - Delete the private implementation logic (it's now in StorageManager)

5. **Update all internal `this.maps.get(...)` usages**:
   - Replace with `this.storageManager.getMap(...)` or `this.storageManager.getMaps().get(...)`
   - Search for `this.maps.` and update each occurrence

6. **Update loadMapFromStorage calls**:
   - Change to `this.storageManager.loadMapFromStorage(...)`
   - Delete the private `loadMapFromStorage` method

7. **Update bootstrap controller** (lines 426-427):
   - Change `getMaps: () => this.maps` to `getMaps: () => this.storageManager.getMaps()`

8. **Update debug endpoints** (around line 415):
   - Change `getMaps: () => this.maps` to `getMaps: () => this.storageManager.getMaps()`

9. **Keep storage initialization in ServerCoordinator** (around line 793):
   - The `this.storage.initialize()` call stays in ServerCoordinator
   - But map loading uses `this.storageManager.loadMapFromStorage()`
  </action>
  <verify>
    - `grep -n "private maps:" packages/server/src/ServerCoordinator.ts` returns no matches
    - `pnpm --filter @topgunbuild/server build` succeeds
    - `pnpm --filter @topgunbuild/server test -- --testPathPattern="Storage"` passes
  </verify>
  <done>
    ServerCoordinator no longer owns maps Map
    All map access goes through StorageManager
    Build succeeds
  </done>
</task>

<task type="auto">
  <name>Task 3: Verify extraction and run full test suite</name>
  <files>packages/server/src/coordinator/storage-manager.ts</files>
  <action>
Final verification:

1. **Verify maps Map ownership**:
   - `grep -n "maps:" packages/server/src/ServerCoordinator.ts` should only show storageManager usage
   - `grep -n "private maps" packages/server/src/coordinator/storage-manager.ts` shows the Map

2. **Verify no duplicate code**:
   - Old getMap implementation deleted from ServerCoordinator
   - Old loadMapFromStorage deleted from ServerCoordinator

3. **Run comprehensive tests**:
   ```bash
   pnpm --filter @topgunbuild/server test
   ```

4. **Verify sync protocol still works**:
   - SYNC_INIT handler should use `this.storageManager.getMapAsync()`
   - MERKLE_REQ_BUCKET handler should use `this.storageManager.getMapAsync()`

5. **Check debug logging preserved**:
   - getMapAsync debug logging (TOPGUN_DEBUG check) should be in StorageManager
  </action>
  <verify>
    - `grep -rn "private maps:" packages/server/src/` only shows storage-manager.ts
    - `pnpm --filter @topgunbuild/server test -- --testPathPattern="Sync"` passes
    - `pnpm --filter @topgunbuild/server test` all tests pass
  </verify>
  <done>
    StorageManager is the single owner of maps Map
    No duplicate storage logic in ServerCoordinator
    All server tests pass including sync tests
  </done>
</task>

</tasks>

<verification>
Phase 4 Plan 3 verification:

1. **Module exists**: `packages/server/src/coordinator/storage-manager.ts` exports `StorageManager`
2. **Interface exists**: `packages/server/src/coordinator/types.ts` exports `IStorageManager`
3. **Maps Map moved**: ServerCoordinator no longer has `private maps: Map`
4. **Integration complete**: ServerCoordinator uses StorageManager for all map operations
5. **Tests pass**: `pnpm --filter @topgunbuild/server test` green
</verification>

<success_criteria>
- StorageManager module created with IStorageManager interface
- maps Map ownership transferred to StorageManager
- ServerCoordinator delegates all map operations to StorageManager
- getMap/getMapAsync/loadMapFromStorage moved to StorageManager
- mapLoadingPromises moved to StorageManager
- All existing tests continue to pass
</success_criteria>

<output>
After completion, create `.planning/phases/04-servercoordinator-refactor/04-03-SUMMARY.md`
</output>
