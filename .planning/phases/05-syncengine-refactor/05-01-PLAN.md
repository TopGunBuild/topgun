---
phase: 05-syncengine-refactor
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - packages/client/src/sync/index.ts
  - packages/client/src/sync/types.ts
  - packages/client/src/sync/WebSocketManager.ts
  - packages/client/src/SyncEngine.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SyncEngine delegates all WebSocket/connection operations to WebSocketManager"
    - "WebSocketManager owns connection provider and websocket instance"
    - "Connection events are routed from WebSocketManager to SyncEngine via callbacks"
    - "Messages are deserialized by WebSocketManager and dispatched to SyncEngine"
  artifacts:
    - path: "packages/client/src/sync/types.ts"
      provides: "IWebSocketManager interface"
      contains: "interface IWebSocketManager"
    - path: "packages/client/src/sync/WebSocketManager.ts"
      provides: "WebSocketManager implementation"
      exports: ["WebSocketManager", "WebSocketManagerConfig"]
    - path: "packages/client/src/sync/index.ts"
      provides: "Barrel exports for sync folder"
      exports: ["WebSocketManager", "IWebSocketManager"]
  key_links:
    - from: "packages/client/src/SyncEngine.ts"
      to: "packages/client/src/sync/WebSocketManager.ts"
      via: "constructor injection"
      pattern: "this\\.webSocketManager = new WebSocketManager"
    - from: "packages/client/src/sync/WebSocketManager.ts"
      to: "SyncEngine.handleServerMessage"
      via: "onMessage callback"
      pattern: "onMessage\\("
---

<objective>
Extract WebSocketManager class from SyncEngine to handle all WebSocket/connection operations.

Purpose: WebSocketManager will own the connection lifecycle, message serialization/deserialization, heartbeat mechanism, and reconnection logic. This is the first extraction as it has the most isolated logic and no dependencies on other extracted modules.

Output: New `packages/client/src/sync/` folder with WebSocketManager class and types.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-syncengine-refactor/05-RESEARCH.md

@packages/client/src/SyncEngine.ts
@packages/client/src/connection/SingleServerProvider.ts
@packages/client/src/types.ts
@packages/server/src/coordinator/connection-manager.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create sync folder with types and barrel</name>
  <files>
    packages/client/src/sync/types.ts
    packages/client/src/sync/index.ts
  </files>
  <action>
Create the sync folder structure with shared types:

1. Create `packages/client/src/sync/types.ts`:
   - Define `IWebSocketManager` interface with these methods:
     - `connect(): void` - Initialize connection
     - `sendMessage(message: any, key?: string): boolean` - Send serialized message
     - `canSend(): boolean` - Check if connection ready
     - `isOnline(): boolean` - Check if connected (may not be authenticated)
     - `getConnectionProvider(): IConnectionProvider` - Access provider
     - `close(): void` - Close connection and cleanup
     - `reset(): void` - Reset connection state
     - `on(event: ConnectionProviderEvent, handler: ConnectionEventHandler): void`
     - `off(event: ConnectionProviderEvent, handler: ConnectionEventHandler): void`
   - Define `WebSocketManagerConfig` interface:
     - `serverUrl?: string` - Direct WebSocket URL
     - `connectionProvider?: IConnectionProvider` - Provider (preferred)
     - `stateMachine: SyncStateMachine` - State machine reference
     - `backoffConfig: BackoffConfig` - Reconnection config
     - `heartbeatConfig: HeartbeatConfig` - Heartbeat config
     - `onMessage: (message: any) => void` - Message callback
     - `onConnected?: () => void` - Connection callback
     - `onDisconnected?: () => void` - Disconnection callback
     - `onReconnected?: () => void` - Reconnection callback
   - Import types from `../types` (IConnectionProvider, ConnectionProviderEvent, ConnectionEventHandler)
   - Import from `../SyncStateMachine` (SyncStateMachine)
   - Import BackoffConfig, HeartbeatConfig from `../SyncEngine` (temporary - will be moved later if needed)

2. Create `packages/client/src/sync/index.ts`:
   - Export all from `./types`
   - Export WebSocketManager class (will be added in Task 2)
  </action>
  <verify>
Files exist and TypeScript compiles: `cd packages/client && npx tsc --noEmit`
  </verify>
  <done>
types.ts contains IWebSocketManager interface with all methods, index.ts exports types
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement WebSocketManager class</name>
  <files>
    packages/client/src/sync/WebSocketManager.ts
  </files>
  <action>
Create WebSocketManager class implementing IWebSocketManager:

1. Constructor injection pattern (from Phase 4):
   - Accept WebSocketManagerConfig
   - Store all config as private readonly fields
   - Create SingleServerProvider internally if only serverUrl provided
   - Set `useConnectionProvider` flag based on which mode

2. Move these methods from SyncEngine (lines ~275-475, ~1380-1628):
   - `initConnection()` - Direct WebSocket setup
   - `initConnectionProvider()` - IConnectionProvider setup
   - `sendMessage(message, key?)` - Serialize and send via current connection
   - `canSend()` - Check connection ready state
   - `scheduleReconnect()` - Reconnection with backoff
   - `calculateBackoffDelay()` - Exponential backoff calculation
   - `resetBackoff()` - Reset backoff counter (expose as public)
   - Heartbeat methods: `startHeartbeat()`, `stopHeartbeat()`, `sendPing()`, `handlePong()`, `checkHeartbeatTimeout()`, `getLastRoundTripTime()`, `isConnectionHealthy()`
   - `close()` - Close connection, stop heartbeat, clear timers
   - `reset()` - Reset connection state for reconnection

3. Message routing:
   - In connection handlers (`onmessage`, `connectionProvider.on('message')`):
   - Deserialize message using `deserialize()` from @topgunbuild/core
   - Call `this.config.onMessage(message)` to dispatch to SyncEngine

4. State machine integration:
   - Call `this.config.stateMachine.transition()` for state changes
   - Use stateMachine for state checks (not duplicate boolean flags)

5. Event forwarding:
   - Implement `on(event, handler)` and `off(event, handler)` to manage listeners
   - For IConnectionProvider mode, forward events from provider
   - For direct WebSocket mode, manage custom listener map

Note: Keep PONG handling in WebSocketManager but call back to SyncEngine if needed for HLC sync (currently not needed - just updates local RTT).
  </action>
  <verify>
TypeScript compiles: `cd packages/client && npx tsc --noEmit`
  </verify>
  <done>
WebSocketManager class exists with all connection/heartbeat/reconnection methods migrated from SyncEngine
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate WebSocketManager into SyncEngine</name>
  <files>
    packages/client/src/SyncEngine.ts
  </files>
  <action>
Refactor SyncEngine to use WebSocketManager:

1. Add imports:
   - Import `WebSocketManager`, `WebSocketManagerConfig` from `./sync`

2. Constructor changes:
   - Remove direct websocket/connectionProvider initialization
   - Create WebSocketManager with config:
     ```typescript
     this.webSocketManager = new WebSocketManager({
       serverUrl: config.serverUrl,
       connectionProvider: config.connectionProvider,
       stateMachine: this.stateMachine,
       backoffConfig: this.backoffConfig,
       heartbeatConfig: this.heartbeatConfig,
       onMessage: (msg) => this.handleServerMessage(msg),
       onConnected: () => { /* auth logic stays here */ },
       onDisconnected: () => { /* disconnect handling */ },
       onReconnected: () => { /* reauth logic */ },
     });
     ```

3. Remove migrated methods from SyncEngine:
   - Delete `initConnection()`, `initConnectionProvider()`
   - Delete `sendMessage()` - replace calls with `this.webSocketManager.sendMessage()`
   - Delete `canSend()` - replace calls with `this.webSocketManager.canSend()`
   - Delete `scheduleReconnect()`, `calculateBackoffDelay()`
   - Delete heartbeat methods (startHeartbeat, stopHeartbeat, sendPing, handlePong, checkHeartbeatTimeout)
   - Keep `getLastRoundTripTime()` and `isConnectionHealthy()` but delegate to webSocketManager

4. Keep in SyncEngine:
   - `isOnline()`, `isAuthenticated()`, `isConnected()` - these use stateMachine directly
   - All auth methods (setAuthToken, setTokenProvider, sendAuth)
   - All message handling (handleServerMessage switch statement)
   - All CRDT, topic, query, lock, counter operations

5. Update method calls throughout SyncEngine:
   - Replace `this.websocket` checks with `this.webSocketManager.canSend()`
   - Replace `this.sendMessage(...)` with `this.webSocketManager.sendMessage(...)`
   - Replace `this.stopHeartbeat()` with `this.webSocketManager.stopHeartbeat()`
   - Replace `this.startHeartbeat()` with `this.webSocketManager.startHeartbeat()`

6. Remove now-unused fields:
   - `private websocket: WebSocket | null`
   - `private reconnectTimer: any`
   - `private backoffAttempt: number`
   - `private heartbeatInterval`
   - `private lastPongReceived`
   - `private lastRoundTripTime`
   - `private readonly useConnectionProvider`
   - `private readonly connectionProvider` - access via webSocketManager.getConnectionProvider()

7. Update close() method:
   - Call `this.webSocketManager.close()` instead of direct websocket close
  </action>
  <verify>
All tests pass: `cd packages/client && pnpm test`
  </verify>
  <done>
SyncEngine delegates all WebSocket operations to WebSocketManager, tests pass, ~330 lines removed from SyncEngine
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds: `cd packages/client && npx tsc --noEmit`
2. All existing tests pass: `cd packages/client && pnpm test`
3. WebSocketManager file exists at `packages/client/src/sync/WebSocketManager.ts`
4. SyncEngine no longer has direct WebSocket handling code
5. Connection behavior unchanged (tests verify this)
</verification>

<success_criteria>
- WebSocketManager class extracted with ~330 lines of connection logic
- SyncEngine reduced by ~330 lines
- IWebSocketManager interface defines clear contract
- All 50+ existing client tests continue to pass
- No public API changes to SyncEngine
</success_criteria>

<output>
After completion, create `.planning/phases/05-syncengine-refactor/05-01-SUMMARY.md`
</output>
