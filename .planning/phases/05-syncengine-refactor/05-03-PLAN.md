---
phase: 05-syncengine-refactor
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - packages/client/src/sync/types.ts
  - packages/client/src/sync/BackpressureController.ts
  - packages/client/src/sync/index.ts
  - packages/client/src/SyncEngine.ts
  - packages/client/src/__tests__/backpressure.test.ts
autonomous: true
user_setup: []

must_haves:
  truths:
    - "SyncEngine delegates all backpressure operations to BackpressureController"
    - "BackpressureController receives opLog reference for pending ops counting"
    - "Backpressure events are emitted by BackpressureController"
    - "Tests access backpressure state via SyncEngine public methods"
  artifacts:
    - path: "packages/client/src/sync/types.ts"
      provides: "IBackpressureController interface"
      contains: "interface IBackpressureController"
    - path: "packages/client/src/sync/BackpressureController.ts"
      provides: "BackpressureController implementation"
      exports: ["BackpressureController", "BackpressureControllerConfig"]
  key_links:
    - from: "packages/client/src/SyncEngine.ts"
      to: "packages/client/src/sync/BackpressureController.ts"
      via: "constructor injection with shared opLog reference"
      pattern: "this\\.backpressureController = new BackpressureController"
    - from: "packages/client/src/sync/BackpressureController.ts"
      to: "opLog array"
      via: "shared reference"
      pattern: "this\\.opLog\\.filter"
---

<objective>
Extract BackpressureController class from SyncEngine to handle all backpressure operations.

Purpose: BackpressureController will manage flow control for pending operations, including pause/resume/throw/drop strategies and high/low water mark events. It receives a shared reference to opLog (SyncEngine retains ownership) for counting pending ops.

Output: BackpressureController class added to `packages/client/src/sync/` folder.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-syncengine-refactor/05-RESEARCH.md
@.planning/phases/05-syncengine-refactor/05-01-SUMMARY.md

@packages/client/src/SyncEngine.ts
@packages/client/src/sync/types.ts
@packages/client/src/BackpressureConfig.ts
@packages/client/src/__tests__/backpressure.test.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add BackpressureController types</name>
  <files>
    packages/client/src/sync/types.ts
  </files>
  <action>
Extend types.ts with BackpressureController interface:

1. Add `IBackpressureController` interface:
   ```typescript
   export interface IBackpressureController {
     /** Get current pending ops count */
     getPendingOpsCount(): number;

     /** Get backpressure status */
     getBackpressureStatus(): BackpressureStatus;

     /** Check if writes are paused */
     isBackpressurePaused(): boolean;

     /** Check backpressure before adding operation (may pause/throw/drop) */
     checkBackpressure(): Promise<void>;

     /** Check high water mark after adding operation */
     checkHighWaterMark(): void;

     /** Check low water mark after ACKs */
     checkLowWaterMark(): void;

     /** Subscribe to backpressure events */
     onBackpressure(
       event: 'backpressure:high' | 'backpressure:low' | 'backpressure:paused' | 'backpressure:resumed' | 'operation:dropped',
       listener: (data?: BackpressureThresholdEvent | OperationDroppedEvent) => void
     ): () => void;
   }
   ```

2. Add `BackpressureControllerConfig` interface:
   ```typescript
   export interface BackpressureControllerConfig {
     /** Backpressure configuration */
     config: BackpressureConfig;
     /** Reference to opLog array (shared state from SyncEngine) */
     opLog: OpLogEntry[];
   }
   ```

3. Add necessary imports at top:
   - Import BackpressureConfig, BackpressureStatus, BackpressureThresholdEvent, OperationDroppedEvent from '../BackpressureConfig'
   - Import OpLogEntry from '../SyncEngine'
  </action>
  <verify>
TypeScript compiles: `cd packages/client && npx tsc --noEmit`
  </verify>
  <done>
IBackpressureController and BackpressureControllerConfig interfaces defined in types.ts
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement BackpressureController class</name>
  <files>
    packages/client/src/sync/BackpressureController.ts
    packages/client/src/sync/index.ts
  </files>
  <action>
Create BackpressureController class implementing IBackpressureController:

1. Create `packages/client/src/sync/BackpressureController.ts`:

2. Constructor injection pattern:
   - Accept BackpressureControllerConfig
   - Store config as private readonly field
   - Store opLog reference (NOT a copy - shared state)

3. Internal state (owned by BackpressureController):
   - `private backpressurePaused: boolean = false`
   - `private waitingForCapacity: Array<() => void> = []`
   - `private highWaterMarkEmitted: boolean = false`
   - `private backpressureListeners: Map<string, Set<(...args: any[]) => void>> = new Map()`

4. Move these methods from SyncEngine (lines ~1708-1905):

   **Status methods:**
   - `getPendingOpsCount()` - Count unsynced ops from opLog
   - `getBackpressureStatus()` - Return full status object
   - `isBackpressurePaused()` - Return pause state

   **Check methods:**
   - `checkBackpressure()` - Called before adding operation, implements strategy
   - `checkHighWaterMark()` - Emit high event if threshold reached
   - `checkLowWaterMark()` - Resume paused writes if below threshold

   **Wait/drop methods:**
   - `waitForCapacity()` - Private, used by pause strategy
   - `dropOldestOp()` - Private, used by drop-oldest strategy (modifies opLog via reference)

   **Event methods:**
   - `onBackpressure(event, listener)` - Subscribe to events
   - `emitBackpressureEvent(event, data?)` - Private, emit to listeners

5. Key implementation detail - opLog access:
   - `getPendingOpsCount()` reads from `this.opLog.filter(op => !op.synced).length`
   - `dropOldestOp()` modifies `this.opLog` via splice (shared reference)
   - This works because arrays are passed by reference in JavaScript

6. Update index.ts:
   - Add export for BackpressureController
  </action>
  <verify>
TypeScript compiles: `cd packages/client && npx tsc --noEmit`
  </verify>
  <done>
BackpressureController class exists with all backpressure methods, uses shared opLog reference
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate BackpressureController and update tests</name>
  <files>
    packages/client/src/SyncEngine.ts
    packages/client/src/__tests__/backpressure.test.ts
  </files>
  <action>
Refactor SyncEngine to use BackpressureController:

1. Add imports:
   - Import `BackpressureController`, `BackpressureControllerConfig` from `./sync`

2. Constructor changes:
   - Create BackpressureController with config:
     ```typescript
     this.backpressureController = new BackpressureController({
       config: this.backpressureConfig,
       opLog: this.opLog,  // Pass reference, not copy
     });
     ```

3. Remove migrated state from SyncEngine:
   - Delete `private backpressurePaused: boolean`
   - Delete `private waitingForCapacity: Array<() => void>`
   - Delete `private highWaterMarkEmitted: boolean`
   - Delete `private backpressureListeners: Map<...>`

4. Remove migrated methods from SyncEngine:
   - Delete `checkBackpressure()` - delegate to controller
   - Delete `checkHighWaterMark()` - delegate to controller
   - Delete `checkLowWaterMark()` - delegate to controller
   - Delete `waitForCapacity()` - moved to controller
   - Delete `dropOldestOp()` - moved to controller
   - Delete `emitBackpressureEvent()` - moved to controller

5. Update delegation methods in SyncEngine (keep public API):
   ```typescript
   public getPendingOpsCount(): number {
     return this.backpressureController.getPendingOpsCount();
   }

   public getBackpressureStatus(): BackpressureStatus {
     return this.backpressureController.getBackpressureStatus();
   }

   public isBackpressurePaused(): boolean {
     return this.backpressureController.isBackpressurePaused();
   }

   public onBackpressure(...): () => void {
     return this.backpressureController.onBackpressure(...);
   }
   ```

6. Update `recordOperation()` method:
   - Replace `await this.checkBackpressure()` with `await this.backpressureController.checkBackpressure()`
   - Replace `this.checkHighWaterMark()` with `this.backpressureController.checkHighWaterMark()`

7. Update OP_ACK handler:
   - Replace `this.checkLowWaterMark()` with `this.backpressureController.checkLowWaterMark()`

8. Update backpressure.test.ts:
   - Tests currently access `(engine as any).opLog` and `(engine as any).checkLowWaterMark()`
   - Replace `(engine as any).opLog` access with helper that adds ops via recordOperation
   - Replace `(engine as any).checkLowWaterMark()` with a method that triggers an OP_ACK simulation
   - Alternative: Add test-only accessors to SyncEngine if needed for test compatibility
   - Goal: Tests verify behavior through public API, not internals

9. SyncEngine keeps opLog ownership:
   - `private opLog: OpLogEntry[] = []` stays in SyncEngine
   - `loadOpLog()`, `saveOpLog()`, `syncPendingOperations()`, `recordOperation()` stay in SyncEngine
   - BackpressureController just reads/modifies via shared reference
  </action>
  <verify>
All tests pass including backpressure tests: `cd packages/client && pnpm test`
  </verify>
  <done>
SyncEngine delegates backpressure to BackpressureController, opLog stays in SyncEngine, ~200 lines extracted, all tests pass
  </done>
</task>

</tasks>

<verification>
1. TypeScript compilation succeeds: `cd packages/client && npx tsc --noEmit`
2. All existing tests pass: `cd packages/client && pnpm test`
3. BackpressureController file exists at `packages/client/src/sync/BackpressureController.ts`
4. SyncEngine no longer has direct backpressure state management
5. Backpressure behavior unchanged (tests verify this)
6. opLog remains in SyncEngine, BackpressureController uses shared reference
</verification>

<success_criteria>
- BackpressureController class extracted with ~200 lines of backpressure logic
- SyncEngine reduced by ~200 lines
- opLog ownership stays with SyncEngine (BackpressureController has reference)
- All existing client tests continue to pass (including backpressure.test.ts)
- No public API changes to SyncEngine
</success_criteria>

<output>
After completion, create `.planning/phases/05-syncengine-refactor/05-03-SUMMARY.md`
</output>
