# TopGun

## What This Is

A hybrid offline-first in-memory data grid providing zero-latency reads/writes via local CRDTs, real-time sync via WebSockets, and durable storage on PostgreSQL.

**Product positioning:** "The reactive data grid that extends the cluster into the browser." TopGun bridges two traditionally separate markets: server-side in-memory data grids (Hazelcast) and client-side offline-first sync engines (PowerSync). Clients are first-class cluster participants with CRDT replicas, not thin proxies.

## Core Value

Local-first data access that never waits for network, with automatic conflict resolution and seamless sync when connectivity is available.

## Tech Stack

| Layer | Technology |
|-------|------------|
| Language (client) | TypeScript |
| Language (server) | TypeScript (migrating to Rust) |
| Runtime (client) | Browser / Node.js |
| Runtime (server) | Node.js (migrating to tokio) |
| Package Manager | pnpm 10.13.1 (monorepo) |
| Build Tool | tsup (TS), Cargo (Rust) |
| Testing | Jest (TS), cargo test + proptest (Rust) |
| Server Transport | WebSocket (ws), HTTP sync |
| Database | PostgreSQL |
| Serialization | msgpackr / rmp-serde (MsgPack) |
| Schema Validation | Zod (TS) / serde (Rust) |

## Project Structure

```
packages/
├── core/               # TS: CRDTs (LWWMap, ORMap), HLC, MerkleTree, schemas
├── client/             # TS: Browser/Node SDK: TopGunClient, SyncEngine
├── server/             # TS: WebSocket server, clustering, PostgreSQL adapter
├── react/              # TS: React bindings: hooks (useQuery, useMap, etc.)
├── adapters/           # TS: Storage implementations (IndexedDB)
├── native/             # N-API: Native xxHash64 for Node.js performance
├── mcp-server/         # TS: MCP server integration
├── adapter-better-auth/ # TS: BetterAuth integration
├── core-rust/          # Rust (planned): CRDTs, HLC, MerkleTree
└── server-rust/        # Rust (planned): Server rewrite (axum, tokio, sqlx)
tests/
├── e2e/                # End-to-end tests
└── k6/                 # Load testing (k6)
```

## Rust Migration Status

**Current phase:** Phase 0 (TypeScript Completion) — finishing client cluster routing (SPEC-048b, 048c)

**Strategy:** Complete TypeScript Wave 1 → Bridge (Cargo workspace + traits) → Rust server rewrite using TS as executable specification.

**Key architectural decisions (2026-02-12):**
- 6 upfront traits gate all Rust architecture (ServerStorage, MapProvider, QueryNotifier, Processor, RequestContext, SchemaProvider)
- TypeScript-first schema strategy (developers define Zod schemas, build step generates Rust)
- Partial replication / Shapes (table stakes feature, SchemaProvider trait)
- MsgPack wire protocol (cross-language, NOT Bincode)
- Selective WASM (DAG executor, tantivy search — NOT basic CRDT ops)

**Full roadmap:** [TODO.md](.specflow/todos/TODO.md)
**Technical research:** [RUST_SERVER_MIGRATION_RESEARCH.md](.specflow/reference/RUST_SERVER_MIGRATION_RESEARCH.md)
**Product positioning:** [PRODUCT_POSITIONING_RESEARCH.md](.specflow/reference/PRODUCT_POSITIONING_RESEARCH.md)

## Patterns & Conventions

- Monorepo with package hierarchy: core -> client/server -> adapters/react
- TypeScript with strict mode
- Commit format: `type(scope): description` (feat, fix, docs, test, chore, refactor, perf)
- Test files co-located with source in `__tests__/` directories
- Server tests use ports 10000+ for servers, 11000+ for cluster nodes
- CRDTs use Hybrid Logical Clocks for causality tracking
- No phase/spec/bug references in code comments — use WHY-comments instead

## Constraints

- Local-first: Reads and writes must never wait for network
- CRDT conflict resolution using LWW-Map and OR-Map
- Must work offline with IndexedDB persistence
- Server-authoritative cluster architecture
- MsgPack wire format for client-server protocol (cross-language compatibility)

## Language Profile

| Setting | Value |
|---------|-------|
| Language | Rust |
| Max files per spec | 5 |
| Trait-first | Yes |

**Notes:**
- Rust specs use trait-first ordering: G1 (Wave 1) defines traits/types only, implementation groups depend on G1
- Max 5 files per spec to limit borrow checker cascade risk
- Applies to `packages/core-rust/` and `packages/server-rust/` only
- TypeScript packages continue using existing conventions (no file limit, no trait-first)

---
*Generated by SpecFlow on 2026-01-20. Updated 2026-02-12 with Rust migration status and product positioning.*
