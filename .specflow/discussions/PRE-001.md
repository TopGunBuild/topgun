---
id: PRE-001
topic: ServerCoordinator.ts further extraction and shortening
feature_type: refactor
created: 2026-01-25
used_by: SPEC-003
---

# Pre-Spec Discussion: ServerCoordinator.ts Extraction

## Feature Type

**Detected:** refactor
**Confirmed:** refactor

## Current State

- **File size:** 3841 lines
- **Existing extractions:** 17+ handlers in `packages/server/src/coordinator/`
- **Remaining responsibilities:** Broadcast, GC, Cluster events, Batch processing, Write concern, Query conversion, Heartbeat, TLS config, Manager instantiations

## Decisions

### Target Size
- **Decision:** Under 1500 lines
- **Rationale:** Significant reduction while maintaining coherent coordination logic

### Extraction Strategy
- **Decision:** Handler extraction pattern
- **Rationale:** Consistent with existing coordinator/ handlers; uses dependency injection

### Backward Compatibility
- **Decision:** Strict compatibility
- **Rationale:** All public methods remain on ServerCoordinator, delegating internally

### Extraction Priority
- **Decision:** Broadcast + GC + Cluster first
- **Details:**
  - BroadcastHandler (~300 lines) - broadcast, broadcastBatch, broadcastBatchSync, getClientRoleSignature
  - GCHandler (~350 lines) - startGarbageCollection, reportLocalHlc, handleGcReport, performGarbageCollection
  - ClusterEventHandler (~200 lines) - setupClusterListeners, handleClusterEvent
- **Expected reduction:** ~850 lines (3841 -> ~2990 lines, additional extractions needed)

### File Location
- **Decision:** coordinator/ folder
- **Path:** `packages/server/src/coordinator/`
- **Rationale:** Keep all handlers together for consistency

### Testing Strategy
- **Decision:** Preserve all tests
- **Rationale:** Existing integration tests must pass unchanged; add unit tests for new handlers

### Verification Criteria
- **Decision:** Tests + size check
- **Criteria:**
  1. All existing tests pass (`pnpm test`)
  2. ServerCoordinator.ts is under 1500 lines
  3. No public API changes

## Summary

Refactor ServerCoordinator.ts from 3841 lines to under 1500 lines by extracting BroadcastHandler, GCHandler, and ClusterEventHandler to the coordinator/ folder. Follow existing handler extraction pattern with dependency injection. Maintain strict backward compatibility - all public methods stay on ServerCoordinator. Success is verified by all tests passing and file size under 1500 lines.

## Specification Created

This discussion was used to create **SPEC-003** on 2026-01-25.
