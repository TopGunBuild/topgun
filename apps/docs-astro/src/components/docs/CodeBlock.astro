---
import { codeToHtml } from 'shiki';

interface Props {
    title: string;
    code: string;
    language?: string;
}

const { title, code, language = 'bash' } = Astro.props;

const html = await codeToHtml(code, {
    lang: language,
    theme: 'vitesse-dark',
});
---

<div class="code-block not-prose rounded-lg border border-card-border bg-[#0d0d0d] overflow-hidden my-6">
    <div class="flex items-center justify-between px-4 py-2 border-b border-white/10 bg-white/5">
        <span class="text-xs font-mono text-neutral-400">{title}</span>
        <button class="copy-btn text-neutral-500 hover:text-white transition-colors" data-code={code}>
            <svg class="w-3 h-3 copy-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <rect width="14" height="14" x="8" y="8" rx="2" ry="2"></rect>
                <path d="M4 16c-1.1 0-2-.9-2-2V4c0-1.1.9-2 2-2h10c1.1 0 2 .9 2 2"></path>
            </svg>
            <svg class="w-3 h-3 check-icon hidden" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"></polyline>
            </svg>
        </button>
    </div>
    <div class="p-4 overflow-x-auto text-sm font-mono [&_pre]:!bg-transparent [&_pre]:!p-0 [&_pre]:!m-0 [&_pre]:!border-0 [&_code]:!bg-transparent [&_code]:whitespace-pre">
        <Fragment set:html={html} />
    </div>
</div>

<script>
    document.querySelectorAll('.code-block .copy-btn').forEach((btn) => {
        btn.addEventListener('click', async () => {
            const code = btn.getAttribute('data-code');
            if (!code) return;

            try {
                await navigator.clipboard.writeText(code);
                const copyIcon = btn.querySelector('.copy-icon');
                const checkIcon = btn.querySelector('.check-icon');

                copyIcon?.classList.add('hidden');
                checkIcon?.classList.remove('hidden');

                setTimeout(() => {
                    copyIcon?.classList.remove('hidden');
                    checkIcon?.classList.add('hidden');
                }, 2000);
            } catch {
                console.error('Failed to copy to clipboard');
            }
        });
    });
</script>
