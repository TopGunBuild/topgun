---
title: Client API
description: The TopGunClient is the main entry point for interacting with the TopGun cluster.
order: 21
---

import CodeBlock from '../../../components/docs/CodeBlock.astro';
import { ChevronRight, Code2, Zap, Database, MessageSquare, Lock, Network, Shield } from 'lucide-react';
import { ApiParam, ApiConstructor } from '../../../components/docs/ApiMethod';

export const startCode = `await client.start();`;

export const getMapCode = `const users = client.getMap<string, User>('users');

// Write data
users.set('u1', { name: 'Alice' });

// Read data
const user = users.get('u1');

// Listen for changes
const unsubscribe = users.onChange(() => {
  console.log('Users map changed');
});`;

export const getORMapCode = `const tags = client.getORMap<string, string>('tags');

// Add values (multiple values per key allowed)
tags.add('post:123', 'javascript');
tags.add('post:123', 'typescript');

// Read all values for a key
const postTags = tags.get('post:123');
// Returns: ['javascript', 'typescript']

// Listen for changes
const unsubscribe = tags.onChange(() => {
  console.log('Tags changed');
});`;

export const topicCode = `const chat = client.topic('chat-room');

// Publish a message
chat.publish({ text: 'Hello!' });

// Subscribe to messages (returns unsubscribe function)
const unsubscribe = chat.subscribe((msg) => {
  console.log(msg);
});

// Later: stop listening
unsubscribe();`;

export const getLockCode = `const lock = client.getLock('resource-A');
if (await lock.lock()) {
  // Critical section
  await lock.unlock();
}`;

export const authCode = `client.setAuthToken('jwt-token-here');`;

export const singleServerCode = `import { TopGunClient, IDBAdapter } from '@topgunbuild/client';

const client = new TopGunClient({
  serverUrl: 'ws://localhost:8765',
  storage: new IDBAdapter(),
});`;

export const clusterModeCode = `import { TopGunClient, IDBAdapter } from '@topgunbuild/client';

const client = new TopGunClient({
  cluster: {
    seeds: [
      'ws://node1.example.com:8765',
      'ws://node2.example.com:8765',
      'ws://node3.example.com:8765',
    ],
    smartRouting: true,        // Enable partition-aware routing
    connectionsPerNode: 2,     // Connection pool size per node
    connectionTimeoutMs: 5000, // Connection timeout
  },
  storage: new IDBAdapter(),
});`;

export const queryCode = `const handle = client.query<Todo>('todos', {
  where: { completed: false },
  sort: { createdAt: 'desc' },
  limit: 10
});

const unsubscribe = handle.subscribe((results) => {
  console.log('Results:', results);
});`;

export const authProviderCode = `// Provider is called on each reconnection
client.setAuthTokenProvider(async () => {
  const token = await refreshToken();
  return token;
});`;

export const unsubscribeCode = `// Data structure changes
const users = client.getMap<string, User>('users');
const unsubscribeMap = users.onChange(() => {
  console.log('Users changed');
});

// Live query results
const query = client.query<Todo>('todos', { where: { done: false } });
const unsubscribeQuery = query.subscribe((results) => {
  console.log('Query results:', results);
});

// Topic messages
const chat = client.topic('chat-room');
const unsubscribeTopic = chat.subscribe((msg) => {
  console.log('New message:', msg);
});

// Later: clean up all subscriptions
unsubscribeMap();
unsubscribeQuery();
unsubscribeTopic();`;

export const failoverMonitorCode = `// Monitor connection state
client.onConnectionChange((state) => {
  if (state === 'connected') {
    console.log('Connected to cluster');
  } else if (state === 'reconnecting') {
    console.log('Reconnecting to cluster...');
  }
});

// Operations continue working during failover
// The client automatically retries on healthy nodes
await users.set('key', { data: 'value' });`;

<div className="flex items-center gap-3 mb-6 not-prose">
  <Code2 className="w-10 h-10 text-blue-600 dark:text-blue-400" />
  <h1 className="text-4xl font-bold text-foreground">Client API</h1>
</div>

The `TopGunClient` is the main entry point for interacting with the TopGun cluster.
It handles connection management, offline synchronization, and provides access to distributed data structures.

## Constructor

<div className="not-prose">
  <ApiConstructor signature="new TopGunClient(config)">
    <ApiParam
      name="serverUrl"
      type="string"
      description="WebSocket URL of the TopGun server (e.g., ws://localhost:8765). Required for single-server mode."
    />
    <ApiParam
      name="cluster?"
      type="ClusterConfig"
      description="Cluster configuration for multi-node deployments. When provided, serverUrl is ignored."
    />
    <ApiParam
      name="storage"
      type="IStorageAdapter"
      description="Persistence adapter (e.g., IDBAdapter)."
    />
    <ApiParam
      name="nodeId?"
      type="string"
      description="Optional unique ID for this client. Auto-generated if omitted."
    />
  </ApiConstructor>
</div>

### Single-Server Mode

For simple deployments with a single TopGun server:

<div className="not-prose">
  <CodeBlock language="typescript" code={singleServerCode} />
</div>

### Cluster Mode

For production deployments with multiple nodes, use the `cluster` configuration:

<div className="not-prose">
  <CodeBlock language="typescript" code={clusterModeCode} />
</div>

<div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl p-6 my-6 not-prose">
  <div className="flex items-center gap-2 mb-2">
    <Network className="w-5 h-5 text-blue-600 dark:text-blue-400" />
    <h4 className="font-semibold text-blue-800 dark:text-blue-300">Smart Routing</h4>
  </div>
  <span className="text-blue-700 dark:text-blue-400">
    When <code className="px-1.5 py-0.5 rounded bg-blue-100 dark:bg-blue-800/50 text-sm">smartRouting</code> is enabled,
    the client automatically routes operations to the correct partition owner node. This reduces network hops and improves latency.
    The client maintains a partition map and updates it automatically when the cluster topology changes.
  </span>
</div>

#### ClusterConfig Options

<div className="not-prose">
  <ApiConstructor signature="interface ClusterConfig">
    <ApiParam
      name="seeds"
      type="string[]"
      description="List of seed node WebSocket URLs. The client connects to these nodes to discover the cluster."
    />
    <ApiParam
      name="smartRouting?"
      type="boolean"
      description="Enable partition-aware routing. Operations are sent directly to partition owners. Default: true."
    />
    <ApiParam
      name="connectionsPerNode?"
      type="number"
      description="Number of connections to maintain per node. Default: 1."
    />
    <ApiParam
      name="partitionMapRefreshMs?"
      type="number"
      description="Interval for refreshing the partition map. Default: 30000 (30 seconds)."
    />
    <ApiParam
      name="connectionTimeoutMs?"
      type="number"
      description="Connection timeout in milliseconds. Default: 10000."
    />
    <ApiParam
      name="retryAttempts?"
      type="number"
      description="Number of retry attempts on connection failure. Default: 3."
    />
  </ApiConstructor>
</div>

## Core Methods

### start()

<div className="flex items-center gap-2 mb-3 not-prose">
  <Zap className="w-5 h-5 text-amber-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Initializes the storage adapter and starts the synchronization engine.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={startCode} />
</div>

<div className="bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-6 my-6 not-prose">
  <h4 className="font-semibold text-green-800 dark:text-green-300 mb-2">Non-Blocking Initialization</h4>
  <span className="text-green-700 dark:text-green-400">
    The <code className="px-1.5 py-0.5 rounded bg-green-100 dark:bg-green-800/50 text-sm">IDBAdapter</code> initializes IndexedDB in the background.
    You can start using the client immediately—write operations are queued in memory and persisted once IndexedDB is ready.
    This provides true "memory-first" behavior with zero blocking time.
  </span>
</div>

### getMap\<K, V\>(name)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Database className="w-5 h-5 text-purple-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Returns an <strong className="text-foreground">LWWMap</strong> (Last-Writer-Wins Map). Best for simple key-value data where the latest update wins.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={getMapCode} />
</div>

### getORMap\<K, V\>(name)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Database className="w-5 h-5 text-purple-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Returns an <strong className="text-foreground">ORMap</strong> (Observed-Remove Map). Best for sets or lists where concurrent additions should be preserved.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={getORMapCode} />
</div>

### topic(name)

<div className="flex items-center gap-2 mb-3 not-prose">
  <MessageSquare className="w-5 h-5 text-green-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Returns a <strong className="text-foreground">TopicHandle</strong> for real-time Pub/Sub messaging. Messages are ephemeral and not stored.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={topicCode} />
</div>

### getLock(name)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Lock className="w-5 h-5 text-red-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Returns a <strong className="text-foreground">DistributedLock</strong> handle. Useful for coordinating tasks across multiple clients.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={getLockCode} />
</div>

### query\<T\>(mapName, filter)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Database className="w-5 h-5 text-purple-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Creates a live query subscription for a map. Returns a <strong className="text-foreground">QueryHandle</strong> that can be subscribed to for real-time updates.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={queryCode} />
</div>

### executeOnKey\<V, R\>(mapName, key, processor)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Zap className="w-5 h-5 text-purple-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Executes an <strong className="text-foreground">Entry Processor</strong> atomically on a single key. Solves read-modify-write race conditions.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={`import { BuiltInProcessors } from '@topgunbuild/core';

// Atomic increment
const result = await client.executeOnKey(
  'stats',     // map name
  'pageViews', // key
  BuiltInProcessors.INCREMENT(1)
);

console.log(result.newValue); // New value after increment
console.log(result.success);  // true`} />
</div>

### executeOnKeys\<V, R\>(mapName, keys, processor)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Zap className="w-5 h-5 text-purple-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Executes an <strong className="text-foreground">Entry Processor</strong> on multiple keys. Returns a Map of results.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={`import { BuiltInProcessors } from '@topgunbuild/core';

// Increment multiple counters
const results = await client.executeOnKeys(
  'counters',
  ['views', 'clicks', 'shares'],
  BuiltInProcessors.INCREMENT(1)
);

for (const [key, result] of results) {
  console.log(\`\${key}: \${result.newValue}\`);
}`} />
</div>

<div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl p-6 my-6 not-prose">
  <div className="flex items-center gap-2 mb-2">
    <Zap className="w-5 h-5 text-blue-600 dark:text-blue-400" />
    <h4 className="font-semibold text-blue-800 dark:text-blue-300">Entry Processor</h4>
  </div>
  <span className="text-blue-700 dark:text-blue-400">
    Entry processors execute user-defined logic atomically on the server. This solves race conditions where multiple clients
    might read, modify, and write the same data concurrently. See the <a href="/docs/guides/entry-processor" className="underline">Entry Processor Guide</a> for detailed usage.
  </span>
</div>

### close()

<div className="flex items-center gap-2 mb-3 not-prose">
  <Zap className="w-5 h-5 text-amber-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Closes the client, disconnecting from the server and cleaning up resources.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code="client.close();" />
</div>

## Authentication

Use `setAuthToken` to authenticate the client. The token is sent to the server on connection and reconnection.

<div className="not-prose">
  <CodeBlock language="typescript" code={authCode} />
</div>

For dynamic token refresh (e.g., when tokens expire), use `setAuthTokenProvider`:

<div className="not-prose">
  <CodeBlock language="typescript" code={authProviderCode} />
</div>

## Unsubscribing from Changes

All subscription methods return an unsubscribe function. Call it to stop receiving updates:

<div className="not-prose">
  <CodeBlock language="typescript" code={unsubscribeCode} />
</div>

<div className="bg-yellow-50 dark:bg-yellow-900/20 border-l-4 border-yellow-500 p-4 my-6 not-prose">
  <p className="text-sm text-yellow-800 dark:text-yellow-200">
    <strong>Important:</strong> The <code className="bg-yellow-100 dark:bg-yellow-800/50 px-1 rounded">onChange()</code> callback receives no arguments—it only signals that something changed.
    To see what changed, re-read the data inside the callback. For filtered results with automatic updates, use <code className="bg-yellow-100 dark:bg-yellow-800/50 px-1 rounded">client.query()</code> instead.
  </p>
</div>

## Cluster Failover

<div className="flex items-center gap-2 mb-3 not-prose">
  <Shield className="w-5 h-5 text-green-500" />
  <span className="text-neutral-600 dark:text-neutral-300">In cluster mode, the client automatically handles node failures with built-in circuit breaker logic.</span>
</div>

When a node becomes unavailable:

1. **Circuit breaker opens** after consecutive failures (default: 5)
2. **Traffic reroutes** to healthy nodes automatically
3. **Circuit resets** after a timeout period (default: 30 seconds)
4. **Partition map updates** when cluster topology changes

<div className="not-prose">
  <CodeBlock language="typescript" code={failoverMonitorCode} />
</div>

<div className="bg-green-50 dark:bg-green-900/20 border border-green-100 dark:border-green-800 rounded-xl p-6 my-6 not-prose">
  <h4 className="font-semibold text-green-800 dark:text-green-300 mb-2">Automatic Recovery</h4>
  <span className="text-green-700 dark:text-green-400">
    The client maintains connections to multiple cluster nodes. If one node fails,
    operations are automatically rerouted to other available nodes. When the failed node
    recovers, the client will start using it again after the circuit breaker resets.
  </span>
</div>

<div className="flex justify-between pt-10 mt-10 border-t border-card-border not-prose">
  <a href="/docs/reference" className="group flex flex-col gap-1 px-6 py-4 rounded-lg border border-card-border hover:border-neutral-400 dark:hover:border-neutral-700 transition-colors">
    <span className="text-xs text-neutral-500">Previous</span>
    <div className="flex items-center gap-2 text-foreground font-semibold">
      <ChevronRight className="w-4 h-4 rotate-180 group-hover:-translate-x-1 transition-transform" /> Overview
    </div>
  </a>
  <a href="/docs/reference/data-structures" className="group flex flex-col items-end gap-1 px-6 py-4 rounded-lg border border-card-border hover:border-neutral-400 dark:hover:border-neutral-700 transition-colors">
    <span className="text-xs text-neutral-500">Next</span>
    <div className="flex items-center gap-2 text-foreground font-semibold">
      Data Structures API <ChevronRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
    </div>
  </a>
</div>
