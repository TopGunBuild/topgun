---
title: Server API
description: The ServerCoordinator is the core of the TopGun backend managing client connections, synchronization, clustering, and security.
order: 22
---

import CodeBlock from '../../../components/docs/CodeBlock.astro';
import { ChevronRight, Server, Settings, Shield, Network, Lock, Gauge, Zap, Timer } from 'lucide-react';
import { ApiParam, ApiConstructor } from '../../../components/docs/ApiMethod';

export const readyCode = `const server = new ServerCoordinator(config);
await server.ready();
console.log(\`Server running on port \${server.port}\`);`;

export const httpSyncRequestExample = `// POST /sync
// Content-Type: application/json
// Authorization: Bearer <your-jwt-token>

{
  "clientId": "client-1",
  "clientHlc": {
    "millis": 1706000000000,
    "counter": 0,
    "nodeId": "client-1"
  },
  "operations": [
    {
      "mapName": "todos",
      "key": "t1",
      "record": {
        "value": { "text": "Buy milk" },
        "timestamp": {
          "millis": 1706000000000,
          "counter": 1,
          "nodeId": "client-1"
        }
      }
    }
  ],
  "syncMaps": [
    {
      "mapName": "todos",
      "lastSyncTimestamp": {
        "millis": 1705999000000,
        "counter": 0,
        "nodeId": ""
      }
    }
  ]
}`;

export const httpSyncResponseExample = `// 200 OK
// Content-Type: application/json

{
  "serverHlc": {
    "millis": 1706000001000,
    "counter": 1,
    "nodeId": "server-1"
  },
  "ack": {
    "lastId": "http-op-0",
    "results": [
      {
        "opId": "http-op-0",
        "success": true,
        "achievedLevel": "MEMORY"
      }
    ]
  },
  "deltas": [
    {
      "mapName": "todos",
      "records": [
        {
          "key": "t2",
          "record": {
            "value": { "text": "Walk the dog" },
            "timestamp": {
              "millis": 1706000000500,
              "counter": 0,
              "nodeId": "client-2"
            }
          },
          "eventType": "PUT"
        }
      ],
      "serverSyncTimestamp": {
        "millis": 1706000001000,
        "counter": 2,
        "nodeId": "server-1"
      }
    }
  ],
  "queryResults": [],
  "searchResults": [],
  "errors": []
}`;

<div className="flex items-center gap-3 mb-6 not-prose">
  <Server className="w-10 h-10 text-blue-600 dark:text-blue-400" />
  <h1 className="text-4xl font-bold text-foreground">Server API</h1>
</div>

The `ServerCoordinator` is the core of the TopGun backend. It manages client connections,
synchronization logic, clustering, and security enforcement.

## Configuration

<div className="not-prose">
  <ApiConstructor signature="interface ServerCoordinatorConfig">
    <ApiParam
      name="port"
      type="number"
      description="Port to listen on for WebSocket connections."
    />
    <ApiParam
      name="storage?"
      type="IServerStorage"
      description="Backend storage adapter. Available adapters: PostgresAdapter (production), MemoryServerAdapter (testing). If omitted, runs in-memory."
    />
    <ApiParam
      name="securityPolicies?"
      type="PermissionPolicy[]"
      description="List of RBAC policies. See RBAC Guide."
    />
    <ApiParam
      name="clusterPort?"
      type="number"
      description="Port for inter-node communication."
    />
    <ApiParam
      name="peers?"
      type="string[]"
      description="List of initial peer addresses for clustering (e.g., ['node2:8000'])."
    />
    <ApiParam
      name="tls?"
      type="TLSConfig"
      description="TLS configuration for client-facing connections (HTTPS/WSS). See TLS Configuration below."
    />
    <ApiParam
      name="clusterTls?"
      type="ClusterTLSConfig"
      description="TLS configuration for inter-node cluster communication. Supports mTLS."
    />
  </ApiConstructor>
</div>

## Connection Scaling Options

<div className="flex items-center gap-2 mb-4 not-prose">
  <Gauge className="w-6 h-6 text-blue-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Configure connection limits and WebSocket parameters for high-load scenarios.</span>
</div>

<div className="not-prose">
  <ApiConstructor signature="Connection Scaling">
    <ApiParam
      name="wsBacklog?"
      type="number"
      description="TCP backlog for pending connections. Increase for high connection rates. Default: 511"
    />
    <ApiParam
      name="wsCompression?"
      type="boolean"
      description="Enable WebSocket per-message compression. Disabled by default for CPU savings. Default: false"
    />
    <ApiParam
      name="wsMaxPayload?"
      type="number"
      description="Maximum WebSocket payload size in bytes. Default: 67108864 (64MB)"
    />
    <ApiParam
      name="maxConnections?"
      type="number"
      description="Maximum concurrent client connections. Default: 10000"
    />
    <ApiParam
      name="serverTimeout?"
      type="number"
      description="Server timeout in milliseconds. Default: 120000 (2 minutes)"
    />
    <ApiParam
      name="keepAliveTimeout?"
      type="number"
      description="Keep-alive timeout in milliseconds. Default: 5000"
    />
    <ApiParam
      name="headersTimeout?"
      type="number"
      description="Headers timeout in milliseconds. Default: 60000"
    />
  </ApiConstructor>
</div>

## Event Queue Options

<div className="flex items-center gap-2 mb-4 not-prose">
  <Zap className="w-6 h-6 text-yellow-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Configure the bounded event queue for backpressure and memory protection.</span>
</div>

<div className="not-prose">
  <ApiConstructor signature="Event Queue">
    <ApiParam
      name="eventQueueCapacity?"
      type="number"
      description="Maximum events in queue. Protects against OOM under load. Default: 10000"
    />
    <ApiParam
      name="eventStripeCount?"
      type="number"
      description="Number of striped queues for parallel processing. Default: 4"
    />
  </ApiConstructor>
</div>

## Backpressure Options

<div className="flex items-center gap-2 mb-4 not-prose">
  <Timer className="w-6 h-6 text-orange-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Control backpressure behavior for async operation management.</span>
</div>

<div className="not-prose">
  <ApiConstructor signature="Backpressure">
    <ApiParam
      name="backpressureEnabled?"
      type="boolean"
      description="Enable backpressure mechanism. Default: true"
    />
    <ApiParam
      name="backpressureSyncFrequency?"
      type="number"
      description="Force synchronous processing every N operations. Lower values reduce latency spikes. Default: 100"
    />
    <ApiParam
      name="backpressureMaxPending?"
      type="number"
      description="Maximum pending async operations before blocking. Default: 1000"
    />
    <ApiParam
      name="backpressureBackoffMs?"
      type="number"
      description="Backoff timeout in milliseconds when at capacity. Default: 5000"
    />
  </ApiConstructor>
</div>

## Write Coalescing Options

<div className="flex items-center gap-2 mb-4 not-prose">
  <Zap className="w-6 h-6 text-purple-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Batch WebSocket writes to reduce syscalls and improve throughput.</span>
</div>

<div className="not-prose">
  <ApiConstructor signature="Write Coalescing">
    <ApiParam
      name="writeCoalescingEnabled?"
      type="boolean"
      description="Enable write batching. Disable for lowest latency real-time apps. Default: true"
    />
    <ApiParam
      name="writeCoalescingMaxBatch?"
      type="number"
      description="Maximum messages per batch before forcing flush. Default: 100"
    />
    <ApiParam
      name="writeCoalescingMaxDelayMs?"
      type="number"
      description="Maximum delay in milliseconds before flushing. Lower values reduce latency. Default: 5"
    />
    <ApiParam
      name="writeCoalescingMaxBytes?"
      type="number"
      description="Maximum batch size in bytes before flushing. Default: 65536 (64KB)"
    />
  </ApiConstructor>
</div>

## Rate Limiting Options

<div className="flex items-center gap-2 mb-4 not-prose">
  <Shield className="w-6 h-6 text-red-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Protect against connection floods and DDoS attacks.</span>
</div>

<div className="not-prose">
  <ApiConstructor signature="Rate Limiting">
    <ApiParam
      name="rateLimitingEnabled?"
      type="boolean"
      description="Enable connection rate limiting. Default: true"
    />
    <ApiParam
      name="maxConnectionsPerSecond?"
      type="number"
      description="Maximum new connections accepted per second. Default: 100"
    />
    <ApiParam
      name="maxPendingConnections?"
      type="number"
      description="Maximum pending connection handshakes. Default: 1000"
    />
  </ApiConstructor>
</div>

## TLS Configuration

<div className="flex items-center gap-2 mb-4 not-prose">
  <Lock className="w-6 h-6 text-green-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Enable TLS/SSL encryption for secure client connections (WSS) and cluster communication.</span>
</div>

<div className="not-prose">
  <ApiConstructor signature="interface TLSConfig">
    <ApiParam
      name="enabled"
      type="boolean"
      description="Enable TLS for client-facing server (HTTPS + WSS). Default: false"
    />
    <ApiParam
      name="certPath"
      type="string"
      description="Path to the certificate file (PEM format). Supports chain certificates."
    />
    <ApiParam
      name="keyPath"
      type="string"
      description="Path to the private key file (PEM format)."
    />
    <ApiParam
      name="caCertPath?"
      type="string"
      description="Path to CA certificate for client certificate verification. Required for mTLS."
    />
    <ApiParam
      name="minVersion?"
      type="'TLSv1.2' | 'TLSv1.3'"
      description="Minimum TLS version. Default: 'TLSv1.2'"
    />
    <ApiParam
      name="ciphers?"
      type="string"
      description="List of allowed cipher suites. Uses Node.js defaults if not specified."
    />
    <ApiParam
      name="passphrase?"
      type="string"
      description="Passphrase for encrypted private key."
    />
  </ApiConstructor>
</div>

<div className="not-prose mt-6">
  <ApiConstructor signature="interface ClusterTLSConfig extends TLSConfig">
    <ApiParam
      name="requireClientCert?"
      type="boolean"
      description="Require client certificate for mTLS (mutual TLS). Default: false"
    />
    <ApiParam
      name="rejectUnauthorized?"
      type="boolean"
      description="Verify peer certificates. Can be disabled for self-signed certs in development. Default: true"
    />
  </ApiConstructor>
</div>

<div className="bg-yellow-50 dark:bg-yellow-900/20 border border-yellow-100 dark:border-yellow-800 rounded-xl p-6 my-6 not-prose">
  <h3 className="text-lg font-semibold text-yellow-800 dark:text-yellow-300 mb-2">Production Warning</h3>
  <span className="text-yellow-700 dark:text-yellow-400">When running in production without TLS enabled, the server will log a warning. Always enable TLS in production environments to protect client data in transit.</span>
</div>

## Methods

### constructor(config)

<div className="flex items-center gap-2 mb-3 not-prose">
  <Settings className="w-5 h-5 text-neutral-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Creates a new server instance but does not start listening immediately.</span>
</div>

### ready()

<div className="flex items-center gap-2 mb-3 not-prose">
  <Network className="w-5 h-5 text-green-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Returns a Promise that resolves when the server is fully started and bound to the port.</span>
</div>

<div className="not-prose">
  <CodeBlock language="typescript" code={readyCode} />
</div>

### shutdown()

<div className="flex items-center gap-2 mb-3 not-prose">
  <Shield className="w-5 h-5 text-red-500" />
  <span className="text-neutral-600 dark:text-neutral-300">Gracefully shuts down the server, closing all client connections, stopping the cluster, and closing storage.</span>
</div>

## POST /sync Endpoint

<div className="flex items-center gap-2 mb-4 not-prose">
  <Network className="w-6 h-6 text-blue-600" />
  <span className="text-neutral-600 dark:text-neutral-300">Stateless HTTP sync endpoint for serverless environments. Accepts batched operations, returns deltas and query results in a single request-response cycle.</span>
</div>

<div className="p-4 bg-neutral-100 dark:bg-neutral-900 rounded-lg mb-6 not-prose">
  <div className="space-y-2 text-sm">
    <div className="flex gap-2">
      <span className="font-semibold text-foreground">URL:</span>
      <code>POST /sync</code>
    </div>
    <div className="flex gap-2">
      <span className="font-semibold text-foreground">Authentication:</span>
      <code>Authorization: Bearer &lt;token&gt;</code> (required)
    </div>
    <div className="flex gap-2">
      <span className="font-semibold text-foreground">Content Types:</span>
      <span className="text-neutral-600 dark:text-neutral-300"><code>application/x-msgpack</code> (default), <code>application/json</code> (fallback)</span>
    </div>
    <div className="flex gap-2">
      <span className="font-semibold text-foreground">Response Format:</span>
      <span className="text-neutral-600 dark:text-neutral-300">Matches request content type</span>
    </div>
  </div>
</div>

### Request Schema (HttpSyncRequest)

<div className="not-prose">
  <ApiConstructor signature="interface HttpSyncRequest">
    <ApiParam
      name="clientId"
      type="string"
      description="Client identifier. Required."
    />
    <ApiParam
      name="clientHlc"
      type="Timestamp"
      description="Client's current Hybrid Logical Clock as an object: { millis: number, counter: number, nodeId: string }. Required."
    />
    <ApiParam
      name="operations?"
      type="ClientOp[]"
      description="Batch of operations to push to the server. Each operation contains mapName, key, and record with value and timestamp."
    />
    <ApiParam
      name="syncMaps?"
      type="SyncMapEntry[]"
      description="Maps to pull deltas for. Each entry contains mapName (string) and lastSyncTimestamp (Timestamp) indicating the last known server state for that map."
    />
    <ApiParam
      name="queries?"
      type="HttpQueryRequest[]"
      description="One-shot queries to execute. Each query contains queryId (string), mapName (string), filter (object), and optional limit (number) and offset (number)."
    />
    <ApiParam
      name="searches?"
      type="HttpSearchRequest[]"
      description="One-shot search requests to execute."
    />
  </ApiConstructor>
</div>

### Response Schema (HttpSyncResponse)

<div className="not-prose">
  <ApiConstructor signature="interface HttpSyncResponse">
    <ApiParam
      name="serverHlc"
      type="Timestamp"
      description="Server's current HLC timestamp as an object: { millis: number, counter: number, nodeId: string }."
    />
    <ApiParam
      name="ack"
      type="{ lastId: string, results?: AckResult[] }"
      description="Acknowledgment of processed operations. lastId is the ID of the last processed operation. results contains per-operation success/failure details with achievedLevel."
    />
    <ApiParam
      name="deltas"
      type="MapDelta[]"
      description="Delta records for requested maps. Each MapDelta contains mapName (string), records (DeltaRecord[] with key, record: LWWRecord, eventType: 'PUT' | 'REMOVE'), and serverSyncTimestamp (Timestamp)."
    />
    <ApiParam
      name="queryResults"
      type="HttpQueryResult[]"
      description="Results for one-shot queries, matching the queryId from the request."
    />
    <ApiParam
      name="searchResults"
      type="HttpSearchResult[]"
      description="Results for one-shot search requests."
    />
    <ApiParam
      name="errors"
      type="HttpSyncError[]"
      description="Errors for individual operations. Each error contains code (string), message (string), and context (object) identifying the failed operation."
    />
  </ApiConstructor>
</div>

### HTTP Status Codes

<div className="overflow-x-auto mb-6 not-prose">
  <table className="w-full text-sm border-collapse">
    <thead>
      <tr className="border-b border-card-border">
        <th className="text-left py-3 px-4 font-semibold text-foreground">Status</th>
        <th className="text-left py-3 px-4 font-semibold text-foreground">Meaning</th>
      </tr>
    </thead>
    <tbody className="text-neutral-600 dark:text-neutral-300">
      <tr className="border-b border-card-border">
        <td className="py-3 px-4 font-mono">200</td>
        <td className="py-3 px-4">Success. Response body contains <code>HttpSyncResponse</code>.</td>
      </tr>
      <tr className="border-b border-card-border">
        <td className="py-3 px-4 font-mono">400</td>
        <td className="py-3 px-4">Invalid request body. Zod schema validation failure.</td>
      </tr>
      <tr className="border-b border-card-border">
        <td className="py-3 px-4 font-mono">401</td>
        <td className="py-3 px-4">Missing or invalid <code>Authorization</code> header. JWT verification failed.</td>
      </tr>
      <tr className="border-b border-card-border">
        <td className="py-3 px-4 font-mono">403</td>
        <td className="py-3 px-4">Permission denied for specific operations. Individual errors appear in the response <code>errors</code> array.</td>
      </tr>
      <tr>
        <td className="py-3 px-4 font-mono">500</td>
        <td className="py-3 px-4">Internal server error.</td>
      </tr>
    </tbody>
  </table>
</div>

### Example Request

<div className="not-prose mb-4">
  <CodeBlock language="json" code={httpSyncRequestExample} />
</div>

<div className="bg-blue-50 dark:bg-blue-900/20 border border-blue-100 dark:border-blue-800 rounded-xl p-4 mb-6 not-prose">
  <span className="text-sm text-blue-700 dark:text-blue-400">The example above uses JSON for readability. In production, the default wire format is <code>application/x-msgpack</code> (msgpackr binary) for smaller payloads and faster serialization. Set <code>Content-Type: application/json</code> to use JSON instead.</span>
</div>

### Example Response

<div className="not-prose">
  <CodeBlock language="json" code={httpSyncResponseExample} />
</div>

<div className="flex justify-between pt-10 mt-10 border-t border-card-border not-prose">
  <a href="/docs/reference/data-structures" className="group flex flex-col gap-1 px-6 py-4 rounded-lg border border-card-border hover:border-neutral-400 dark:hover:border-neutral-700 transition-colors">
    <span className="text-xs text-neutral-500">Previous</span>
    <div className="flex items-center gap-2 text-foreground font-semibold">
      <ChevronRight className="w-4 h-4 rotate-180 group-hover:-translate-x-1 transition-transform" /> Data Structures API
    </div>
  </a>
  <a href="/docs/reference/cli" className="group flex flex-col items-end gap-1 px-6 py-4 rounded-lg border border-card-border hover:border-neutral-400 dark:hover:border-neutral-700 transition-colors">
    <span className="text-xs text-neutral-500">Next</span>
    <div className="flex items-center gap-2 text-foreground font-semibold">
      CLI Reference <ChevronRight className="w-4 h-4 group-hover:translate-x-1 transition-transform" />
    </div>
  </a>
</div>
